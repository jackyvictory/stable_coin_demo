<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVO Payment - Blockchain Monitor Demo</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 25px;
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .status-card h3 {
            border-bottom-color: rgba(255,255,255,0.3);
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #46C16D;
        }
        
        .btn-danger {
            background: #D7272B;
        }
        
        .btn-warning {
            background: #DD6B20;
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-monitoring {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-found {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .payment-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            position: relative;
        }
        
        .payment-item.monitoring {
            border-left: 4px solid #DD6B20;
            background: #fff8f0;
        }
        
        .payment-item.confirmed {
            border-left: 4px solid #46C16D;
            background: #f0fff4;
        }
        
        .payment-item.expired {
            border-left: 4px solid #D7272B;
            background: #fff5f5;
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .log-container {
            height: 250px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .transaction-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .transaction-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
    
    <!-- å¤–éƒ¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="./config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” EVO Payment Monitor Demo</h1>
            <p>åŒºå—é“¾äº¤æ˜“ç›‘å¬å’Œæ”¯ä»˜éªŒè¯åŠŸèƒ½æ¼”ç¤º</p>
        </div>
        
        <div class="demo-grid">
            <!-- ç›‘å¬çŠ¶æ€ -->
            <div class="card status-card">
                <h3>ğŸ“Š ç›‘å¬çŠ¶æ€</h3>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="activeMonitoring">0</div>
                        <div class="stat-label">æ´»è·ƒç›‘å¬</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalPayments">0</div>
                        <div class="stat-label">æ€»æ”¯ä»˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedPayments">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pollingInterval">5s</div>
                        <div class="stat-label">è½®è¯¢é—´éš”</div>
                    </div>
                </div>
                
                <button id="refreshStats" class="btn">åˆ·æ–°ç»Ÿè®¡</button>
                <button id="stopAllMonitoring" class="btn btn-danger">åœæ­¢æ‰€æœ‰ç›‘å¬</button>
            </div>
            
            <!-- åˆ›å»ºæµ‹è¯•æ”¯ä»˜ -->
            <div class="card">
                <h3>ğŸ’³ åˆ›å»ºæµ‹è¯•æ”¯ä»˜</h3>
                
                <div class="form-group">
                    <label for="testAmount">æ”¯ä»˜é‡‘é¢ (USD)</label>
                    <input type="number" id="testAmount" value="1.0" min="0.01" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="testToken">ä»£å¸ç±»å‹</label>
                    <select id="testToken">
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                        <option value="BUSD">BUSD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="testUserAddress">ç”¨æˆ·åœ°å€</label>
                    <input type="text" id="testUserAddress" placeholder="0x..." value="0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6">
                </div>
                
                <button id="createTestPayment" class="btn">åˆ›å»ºæµ‹è¯•æ”¯ä»˜</button>
                <button id="createAndMonitor" class="btn btn-success">åˆ›å»ºå¹¶å¼€å§‹ç›‘å¬</button>
                
                <div id="testPaymentResult" class="info-display hidden"></div>
            </div>
            
            <!-- ç›‘å¬æ§åˆ¶ -->
            <div class="card">
                <h3>ğŸ›ï¸ ç›‘å¬æ§åˆ¶</h3>
                
                <div class="form-group">
                    <label for="monitorPaymentId">æ”¯ä»˜ID</label>
                    <input type="text" id="monitorPaymentId" placeholder="è¾“å…¥æ”¯ä»˜ID">
                </div>
                
                <div class="form-group">
                    <label for="monitorFromBlock">èµ·å§‹åŒºå— (å¯é€‰)</label>
                    <input type="number" id="monitorFromBlock" placeholder="ç•™ç©ºä½¿ç”¨æœ€æ–°åŒºå—">
                </div>
                
                <button id="startMonitoring" class="btn">å¼€å§‹ç›‘å¬</button>
                <button id="stopMonitoring" class="btn btn-secondary">åœæ­¢ç›‘å¬</button>
                <button id="checkOnce" class="btn btn-warning">å•æ¬¡æ£€æŸ¥</button>
                
                <div id="monitoringStatus" class="status-indicator hidden"></div>
            </div>
            
            <!-- æ¨¡æ‹Ÿäº¤æ˜“ -->
            <div class="card">
                <h3>ğŸ­ æ¨¡æ‹Ÿäº¤æ˜“</h3>
                
                <div class="form-group">
                    <label for="simulatePaymentId">æ”¯ä»˜ID</label>
                    <input type="text" id="simulatePaymentId" placeholder="è¾“å…¥æ”¯ä»˜ID">
                </div>
                
                <div class="form-group">
                    <label for="simulateTxHash">æ¨¡æ‹Ÿäº¤æ˜“å“ˆå¸Œ</label>
                    <input type="text" id="simulateTxHash" placeholder="0x..." value="0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef">
                </div>
                
                <button id="simulatePaymentFound" class="btn btn-success">æ¨¡æ‹Ÿæ‰¾åˆ°æ”¯ä»˜</button>
                <button id="simulatePaymentExpired" class="btn btn-warning">æ¨¡æ‹Ÿæ”¯ä»˜è¿‡æœŸ</button>
                <button id="simulatePaymentError" class="btn btn-danger">æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯</button>
                
                <div id="simulationResult" class="info-display hidden"></div>
            </div>
            
            <!-- æ”¯ä»˜åˆ—è¡¨ -->
            <div class="card">
                <h3>ğŸ“‹ æ”¯ä»˜åˆ—è¡¨</h3>
                
                <div class="form-group">
                    <label for="paymentFilter">çŠ¶æ€è¿‡æ»¤</label>
                    <select id="paymentFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="monitoring">ç›‘å¬ä¸­</option>
                        <option value="confirmed">å·²ç¡®è®¤</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                        <option value="failed">å¤±è´¥</option>
                    </select>
                </div>
                
                <button id="refreshPaymentList" class="btn">åˆ·æ–°åˆ—è¡¨</button>
                <button id="clearAllPayments" class="btn btn-danger">æ¸…é™¤æ‰€æœ‰</button>
                
                <div id="paymentList">
                    <!-- æ”¯ä»˜åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- äº¤æ˜“è¯¦æƒ… -->
            <div class="card">
                <h3>ğŸ” äº¤æ˜“è¯¦æƒ…</h3>
                
                <div class="form-group">
                    <label for="txHashQuery">äº¤æ˜“å“ˆå¸Œ</label>
                    <input type="text" id="txHashQuery" placeholder="0x...">
                </div>
                
                <button id="queryTransactionDetail" class="btn">æŸ¥è¯¢è¯¦æƒ…</button>
                
                <div id="transactionDetail" class="info-display hidden"></div>
            </div>
            
            <!-- å®æ—¶æ—¥å¿— -->
            <div class="card">
                <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
                
                <div id="realtimeLog" class="log-container">
                    <!-- å®æ—¶æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <button id="clearLog" class="btn btn-secondary">æ¸…é™¤æ—¥å¿—</button>
                <button id="exportLog" class="btn btn-secondary">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
    </div>
    
    <!-- ä¾èµ–è„šæœ¬ -->
    <script src="./js/blockchain-connector.js"></script>
    <script src="./js/payment-handler.js"></script>
    <script src="./js/blockchain-monitor.js"></script>
    
    <!-- æ¼”ç¤ºè„šæœ¬ -->
    <script>
        // DOM å…ƒç´ 
        const elements = {
            // ç»Ÿè®¡
            activeMonitoring: document.getElementById('activeMonitoring'),
            totalPayments: document.getElementById('totalPayments'),
            completedPayments: document.getElementById('completedPayments'),
            pollingInterval: document.getElementById('pollingInterval'),
            refreshStats: document.getElementById('refreshStats'),
            stopAllMonitoring: document.getElementById('stopAllMonitoring'),
            
            // æµ‹è¯•æ”¯ä»˜
            testAmount: document.getElementById('testAmount'),
            testToken: document.getElementById('testToken'),
            testUserAddress: document.getElementById('testUserAddress'),
            createTestPayment: document.getElementById('createTestPayment'),
            createAndMonitor: document.getElementById('createAndMonitor'),
            testPaymentResult: document.getElementById('testPaymentResult'),
            
            // ç›‘å¬æ§åˆ¶
            monitorPaymentId: document.getElementById('monitorPaymentId'),
            monitorFromBlock: document.getElementById('monitorFromBlock'),
            startMonitoring: document.getElementById('startMonitoring'),
            stopMonitoring: document.getElementById('stopMonitoring'),
            checkOnce: document.getElementById('checkOnce'),
            monitoringStatus: document.getElementById('monitoringStatus'),
            
            // æ¨¡æ‹Ÿäº¤æ˜“
            simulatePaymentId: document.getElementById('simulatePaymentId'),
            simulateTxHash: document.getElementById('simulateTxHash'),
            simulatePaymentFound: document.getElementById('simulatePaymentFound'),
            simulatePaymentExpired: document.getElementById('simulatePaymentExpired'),
            simulatePaymentError: document.getElementById('simulatePaymentError'),
            simulationResult: document.getElementById('simulationResult'),
            
            // æ”¯ä»˜åˆ—è¡¨
            paymentFilter: document.getElementById('paymentFilter'),
            refreshPaymentList: document.getElementById('refreshPaymentList'),
            clearAllPayments: document.getElementById('clearAllPayments'),
            paymentList: document.getElementById('paymentList'),
            
            // äº¤æ˜“è¯¦æƒ…
            txHashQuery: document.getElementById('txHashQuery'),
            queryTransactionDetail: document.getElementById('queryTransactionDetail'),
            transactionDetail: document.getElementById('transactionDetail'),
            
            // æ—¥å¿—
            realtimeLog: document.getElementById('realtimeLog'),
            clearLog: document.getElementById('clearLog'),
            exportLog: document.getElementById('exportLog')
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Blockchain Monitor Demo åˆå§‹åŒ–');
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // è®¾ç½®ç›‘å¬å™¨äº‹ä»¶
            setupMonitorEventListeners();
            
            // åˆå§‹åŒ–æ•°æ®
            refreshStats();
            refreshPaymentList();
            
            logMessage('ğŸš€ Blockchain Monitor Demo å·²åŠ è½½');
        });
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç»Ÿè®¡
            elements.refreshStats.addEventListener('click', refreshStats);
            elements.stopAllMonitoring.addEventListener('click', stopAllMonitoring);
            
            // æµ‹è¯•æ”¯ä»˜
            elements.createTestPayment.addEventListener('click', createTestPayment);
            elements.createAndMonitor.addEventListener('click', createAndMonitor);
            
            // ç›‘å¬æ§åˆ¶
            elements.startMonitoring.addEventListener('click', startMonitoring);
            elements.stopMonitoring.addEventListener('click', stopMonitoring);
            elements.checkOnce.addEventListener('click', checkOnce);
            
            // æ¨¡æ‹Ÿäº¤æ˜“
            elements.simulatePaymentFound.addEventListener('click', simulatePaymentFound);
            elements.simulatePaymentExpired.addEventListener('click', simulatePaymentExpired);
            elements.simulatePaymentError.addEventListener('click', simulatePaymentError);
            
            // æ”¯ä»˜åˆ—è¡¨
            elements.refreshPaymentList.addEventListener('click', refreshPaymentList);
            elements.clearAllPayments.addEventListener('click', clearAllPayments);
            elements.paymentFilter.addEventListener('change', refreshPaymentList);
            
            // äº¤æ˜“è¯¦æƒ…
            elements.queryTransactionDetail.addEventListener('click', queryTransactionDetail);
            
            // æ—¥å¿—
            elements.clearLog.addEventListener('click', clearRealtimeLog);
            elements.exportLog.addEventListener('click', exportLog);
        }
        
        // è®¾ç½®ç›‘å¬å™¨äº‹ä»¶
        function setupMonitorEventListeners() {
            // ç›‘å¬å¼€å§‹
            window.addEventListener('monitoringStarted', (event) => {
                const { paymentId } = event.detail;
                logMessage(`ğŸ” å¼€å§‹ç›‘å¬æ”¯ä»˜: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // ç›‘å¬åœæ­¢
            window.addEventListener('monitoringStopped', (event) => {
                const { paymentId } = event.detail;
                logMessage(`â¹ï¸ åœæ­¢ç›‘å¬æ”¯ä»˜: ${paymentId}`);
                refreshStats();
            });
            
            // æ”¯ä»˜æ‰¾åˆ°
            window.addEventListener('paymentFound', (event) => {
                const { paymentId, transaction } = event.detail;
                logMessage(`âœ… æ‰¾åˆ°æ”¯ä»˜: ${paymentId} - ${transaction.hash}`);
                refreshPaymentList();
            });
            
            // æ”¯ä»˜å®Œæˆ
            window.addEventListener('paymentCompleted', (event) => {
                const { paymentId, transaction } = event.detail;
                logMessage(`ğŸ‰ æ”¯ä»˜å®Œæˆ: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // æ”¯ä»˜è¿‡æœŸ
            window.addEventListener('paymentExpired', (event) => {
                const { paymentId } = event.detail;
                logMessage(`â° æ”¯ä»˜è¿‡æœŸ: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // æ”¯ä»˜é”™è¯¯
            window.addEventListener('paymentError', (event) => {
                const { paymentId, error } = event.detail;
                logMessage(`âŒ æ”¯ä»˜é”™è¯¯: ${paymentId} - ${error.message}`);
                refreshStats();
                refreshPaymentList();
            });
        }
        
        // åˆ·æ–°ç»Ÿè®¡
        function refreshStats() {
            try {
                const monitorStats = window.BlockchainMonitor.getMonitoringStats();
                const paymentStats = window.PaymentHandler.getPaymentStats();
                
                elements.activeMonitoring.textContent = monitorStats.activeMonitoring;
                elements.totalPayments.textContent = paymentStats.total;
                elements.completedPayments.textContent = paymentStats.completed;
                elements.pollingInterval.textContent = (monitorStats.pollingInterval / 1000) + 's';
                
            } catch (error) {
                logMessage(`âŒ åˆ·æ–°ç»Ÿè®¡å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ›å»ºæµ‹è¯•æ”¯ä»˜
        function createTestPayment() {
            try {
                const amount = parseFloat(elements.testAmount.value);
                const token = elements.testToken.value;
                const userAddress = elements.testUserAddress.value;
                
                if (!amount || amount <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                }
                
                if (!userAddress) {
                    throw new Error('è¯·è¾“å…¥ç”¨æˆ·åœ°å€');
                }
                
                const payment = window.PaymentHandler.createPayment({
                    amount,
                    token,
                    userAddress
                });
                
                elements.testPaymentResult.textContent = JSON.stringify(payment, null, 2);
                elements.testPaymentResult.classList.remove('hidden');
                
                // è‡ªåŠ¨å¡«å……æ”¯ä»˜ID
                elements.monitorPaymentId.value = payment.paymentId;
                elements.simulatePaymentId.value = payment.paymentId;
                
                refreshStats();
                refreshPaymentList();
                
                logMessage(`âœ… åˆ›å»ºæµ‹è¯•æ”¯ä»˜: ${payment.paymentId}`);
                
            } catch (error) {
                alert('åˆ›å»ºæµ‹è¯•æ”¯ä»˜å¤±è´¥: ' + error.message);
                logMessage(`âŒ åˆ›å»ºæµ‹è¯•æ”¯ä»˜å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ›å»ºå¹¶ç›‘å¬
        async function createAndMonitor() {
            try {
                // å…ˆåˆ›å»ºæ”¯ä»˜
                createTestPayment();
                
                // ç­‰å¾…ä¸€ä¸‹å†å¼€å§‹ç›‘å¬
                setTimeout(async () => {
                    const paymentId = elements.monitorPaymentId.value;
                    if (paymentId) {
                        await startMonitoringPayment(paymentId);
                    }
                }, 500);
                
            } catch (error) {
                logMessage(`âŒ åˆ›å»ºå¹¶ç›‘å¬å¤±è´¥: ${error.message}`);
            }
        }
        
        // å¼€å§‹ç›‘å¬
        async function startMonitoring() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('è¯·è¾“å…¥æ”¯ä»˜ID');
                return;
            }
            
            await startMonitoringPayment(paymentId);
        }
        
        // å¼€å§‹ç›‘å¬æ”¯ä»˜
        async function startMonitoringPayment(paymentId) {
            try {
                showLoading(elements.startMonitoring, 'å¼€å§‹ä¸­...');
                
                const options = {};
                const fromBlock = elements.monitorFromBlock.value;
                if (fromBlock) {
                    options.fromBlock = parseInt(fromBlock);
                }
                
                await window.BlockchainMonitor.startMonitoring(paymentId, options);
                
                elements.monitoringStatus.textContent = `âœ… å¼€å§‹ç›‘å¬: ${paymentId}`;
                elements.monitoringStatus.className = 'status-indicator status-monitoring';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`ğŸ” å¼€å§‹ç›‘å¬: ${paymentId}`);
                
            } catch (error) {
                elements.monitoringStatus.textContent = `âŒ ç›‘å¬å¤±è´¥: ${error.message}`;
                elements.monitoringStatus.className = 'status-indicator status-error';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`âŒ å¼€å§‹ç›‘å¬å¤±è´¥: ${error.message}`);
                alert('å¼€å§‹ç›‘å¬å¤±è´¥: ' + error.message);
            } finally {
                hideLoading(elements.startMonitoring, 'å¼€å§‹ç›‘å¬');
            }
        }
        
        // åœæ­¢ç›‘å¬
        function stopMonitoring() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('è¯·è¾“å…¥æ”¯ä»˜ID');
                return;
            }
            
            try {
                window.BlockchainMonitor.stopMonitoring(paymentId);
                
                elements.monitoringStatus.textContent = `â¹ï¸ å·²åœæ­¢ç›‘å¬: ${paymentId}`;
                elements.monitoringStatus.className = 'status-indicator';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`â¹ï¸ åœæ­¢ç›‘å¬: ${paymentId}`);
                
            } catch (error) {
                logMessage(`âŒ åœæ­¢ç›‘å¬å¤±è´¥: ${error.message}`);
                alert('åœæ­¢ç›‘å¬å¤±è´¥: ' + error.message);
            }
        }
        
        // å•æ¬¡æ£€æŸ¥
        async function checkOnce() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('è¯·è¾“å…¥æ”¯ä»˜ID');
                return;
            }
            
            try {
                showLoading(elements.checkOnce, 'æ£€æŸ¥ä¸­...');
                
                await window.BlockchainMonitor.checkPaymentTransaction(paymentId);
                
                logMessage(`ğŸ” å•æ¬¡æ£€æŸ¥å®Œæˆ: ${paymentId}`);
                
            } catch (error) {
                logMessage(`âŒ å•æ¬¡æ£€æŸ¥å¤±è´¥: ${error.message}`);
                alert('å•æ¬¡æ£€æŸ¥å¤±è´¥: ' + error.message);
            } finally {
                hideLoading(elements.checkOnce, 'å•æ¬¡æ£€æŸ¥');
            }
        }
        
        // åœæ­¢æ‰€æœ‰ç›‘å¬
        function stopAllMonitoring() {
            if (confirm('ç¡®å®šè¦åœæ­¢æ‰€æœ‰ç›‘å¬å—ï¼Ÿ')) {
                window.BlockchainMonitor.stopAllMonitoring();
                refreshStats();
                logMessage('ğŸ›‘ å·²åœæ­¢æ‰€æœ‰ç›‘å¬');
            }
        }
        
        // æ¨¡æ‹Ÿæ‰¾åˆ°æ”¯ä»˜
        function simulatePaymentFound() {
            const paymentId = elements.simulatePaymentId.value;
            const txHash = elements.simulateTxHash.value;
            
            if (!paymentId || !txHash) {
                alert('è¯·è¾“å…¥æ”¯ä»˜IDå’Œäº¤æ˜“å“ˆå¸Œ');
                return;
            }
            
            try {
                const mockTransaction = {
                    hash: txHash,
                    blockNumber: 12345678,
                    from: '0x1234567890123456789012345678901234567890',
                    to: window.EVO_CONFIG.APP_CONFIG.payment.receiverAddress,
                    value: '1000000000000000000', // 1 token
                    type: 'token_transfer'
                };
                
                window.BlockchainMonitor.handlePaymentFound(paymentId, mockTransaction);
                
                elements.simulationResult.textContent = `æ¨¡æ‹Ÿæ‰¾åˆ°æ”¯ä»˜æˆåŠŸ:\n${JSON.stringify(mockTransaction, null, 2)}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`ğŸ­ æ¨¡æ‹Ÿæ‰¾åˆ°æ”¯ä»˜: ${paymentId}`);
                
            } catch (error) {
                logMessage(`âŒ æ¨¡æ‹Ÿæ‰¾åˆ°æ”¯ä»˜å¤±è´¥: ${error.message}`);
                alert('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
            }
        }
        
        // æ¨¡æ‹Ÿæ”¯ä»˜è¿‡æœŸ
        function simulatePaymentExpired() {
            const paymentId = elements.simulatePaymentId.value;
            
            if (!paymentId) {
                alert('è¯·è¾“å…¥æ”¯ä»˜ID');
                return;
            }
            
            try {
                window.BlockchainMonitor.handlePaymentExpired(paymentId);
                
                elements.simulationResult.textContent = `æ¨¡æ‹Ÿæ”¯ä»˜è¿‡æœŸæˆåŠŸ: ${paymentId}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`ğŸ­ æ¨¡æ‹Ÿæ”¯ä»˜è¿‡æœŸ: ${paymentId}`);
                
            } catch (error) {
                logMessage(`âŒ æ¨¡æ‹Ÿæ”¯ä»˜è¿‡æœŸå¤±è´¥: ${error.message}`);
                alert('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
            }
        }
        
        // æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯
        function simulatePaymentError() {
            const paymentId = elements.simulatePaymentId.value;
            
            if (!paymentId) {
                alert('è¯·è¾“å…¥æ”¯ä»˜ID');
                return;
            }
            
            try {
                const mockError = new Error('æ¨¡æ‹Ÿçš„ç½‘ç»œé”™è¯¯');
                window.BlockchainMonitor.handlePaymentError(paymentId, mockError);
                
                elements.simulationResult.textContent = `æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯æˆåŠŸ: ${paymentId}\né”™è¯¯: ${mockError.message}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`ğŸ­ æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯: ${paymentId}`);
                
            } catch (error) {
                logMessage(`âŒ æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯å¤±è´¥: ${error.message}`);
                alert('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ·æ–°æ”¯ä»˜åˆ—è¡¨
        function refreshPaymentList() {
            try {
                const filter = elements.paymentFilter.value;
                const filters = filter ? { status: filter } : {};
                const payments = window.PaymentHandler.getAllPayments(filters);
                
                elements.paymentList.innerHTML = '';
                
                if (payments.length === 0) {
                    elements.paymentList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ”¯ä»˜è®°å½•</p>';
                    return;
                }
                
                payments.forEach(payment => {
                    const item = document.createElement('div');
                    item.className = `payment-item ${payment.status}`;
                    
                    const isMonitoring = window.BlockchainMonitor.activePayments.has(payment.paymentId);
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${payment.paymentId}</strong>
                            <span class="status-indicator status-${payment.status}" style="padding: 2px 8px; font-size: 12px;">
                                ${payment.status.toUpperCase()}
                                ${isMonitoring ? ' (ç›‘å¬ä¸­)' : ''}
                            </span>
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            <p>ğŸ’° é‡‘é¢: $${payment.amount} ${payment.tokenSymbol}</p>
                            <p>ğŸ“… åˆ›å»º: ${payment.createdAt.toLocaleString()}</p>
                            <p>â° è¿‡æœŸ: ${payment.expiresAt.toLocaleString()}</p>
                            ${payment.txHash ? `<p>ğŸ”— äº¤æ˜“: ${payment.txHash.substring(0, 20)}...</p>` : ''}
                        </div>
                        <div class="payment-actions">
                            <button class="btn" onclick="startMonitoringFromList('${payment.paymentId}')" 
                                    ${isMonitoring || !['pending'].includes(payment.status) ? 'disabled' : ''}>
                                å¼€å§‹ç›‘å¬
                            </button>
                            <button class="btn btn-secondary" onclick="stopMonitoringFromList('${payment.paymentId}')"
                                    ${!isMonitoring ? 'disabled' : ''}>
                                åœæ­¢ç›‘å¬
                            </button>
                            <button class="btn btn-warning" onclick="checkPaymentFromList('${payment.paymentId}')">
                                æ£€æŸ¥çŠ¶æ€
                            </button>
                        </div>
                    `;
                    
                    elements.paymentList.appendChild(item);
                });
                
            } catch (error) {
                logMessage(`âŒ åˆ·æ–°æ”¯ä»˜åˆ—è¡¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // ä»åˆ—è¡¨å¼€å§‹ç›‘å¬
        window.startMonitoringFromList = async function(paymentId) {
            elements.monitorPaymentId.value = paymentId;
            await startMonitoringPayment(paymentId);
        };
        
        // ä»åˆ—è¡¨åœæ­¢ç›‘å¬
        window.stopMonitoringFromList = function(paymentId) {
            window.BlockchainMonitor.stopMonitoring(paymentId);
            refreshPaymentList();
        };
        
        // ä»åˆ—è¡¨æ£€æŸ¥æ”¯ä»˜
        window.checkPaymentFromList = async function(paymentId) {
            try {
                await window.BlockchainMonitor.checkPaymentTransaction(paymentId);
                refreshPaymentList();
                logMessage(`ğŸ” æ£€æŸ¥æ”¯ä»˜çŠ¶æ€: ${paymentId}`);
            } catch (error) {
                logMessage(`âŒ æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        };
        
        // æ¸…é™¤æ‰€æœ‰æ”¯ä»˜
        function clearAllPayments() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ”¯ä»˜è®°å½•å—ï¼Ÿ')) {
                window.PaymentHandler.payments.clear();
                window.BlockchainMonitor.stopAllMonitoring();
                refreshStats();
                refreshPaymentList();
                logMessage('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ”¯ä»˜è®°å½•');
            }
        }
        
        // æŸ¥è¯¢äº¤æ˜“è¯¦æƒ…
        async function queryTransactionDetail() {
            const txHash = elements.txHashQuery.value;
            
            if (!txHash) {
                alert('è¯·è¾“å…¥äº¤æ˜“å“ˆå¸Œ');
                return;
            }
            
            try {
                showLoading(elements.queryTransactionDetail, 'æŸ¥è¯¢ä¸­...');
                
                const txInfo = await window.BlockchainConnector.getTransaction(txHash);
                
                elements.transactionDetail.textContent = JSON.stringify(txInfo, null, 2);
                elements.transactionDetail.classList.remove('hidden');
                
                logMessage(`ğŸ” æŸ¥è¯¢äº¤æ˜“è¯¦æƒ…: ${txHash.substring(0, 20)}...`);
                
            } catch (error) {
                elements.transactionDetail.textContent = `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                elements.transactionDetail.classList.remove('hidden');
                
                logMessage(`âŒ æŸ¥è¯¢äº¤æ˜“è¯¦æƒ…å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading(elements.queryTransactionDetail, 'æŸ¥è¯¢è¯¦æƒ…');
            }
        }
        
        // æ¸…é™¤æ—¥å¿—
        function clearRealtimeLog() {
            elements.realtimeLog.textContent = '';
        }
        
        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = elements.realtimeLog.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitor-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            logMessage('ğŸ“¥ æ—¥å¿—å·²å¯¼å‡º');
        }
        
        // è®°å½•æ—¥å¿—
        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            elements.realtimeLog.textContent += logEntry;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            elements.realtimeLog.scrollTop = elements.realtimeLog.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—é•¿åº¦
            const lines = elements.realtimeLog.textContent.split('\n');
            if (lines.length > 200) {
                elements.realtimeLog.textContent = lines.slice(-200).join('\n');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function showLoading(button, text) {
            button.innerHTML = `<span class="loading"></span> ${text}`;
            button.disabled = true;
        }
        
        function hideLoading(button, text) {
            button.innerHTML = text;
            button.disabled = false;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            logMessage('ğŸš€ Blockchain Monitor Demo å·²åŠ è½½');
            logMessage('ğŸ’¡ æç¤º: åˆ›å»ºæµ‹è¯•æ”¯ä»˜å¹¶å¼€å§‹ç›‘å¬ä½“éªŒåŠŸèƒ½');
        });
    </script>
</body>
</html>