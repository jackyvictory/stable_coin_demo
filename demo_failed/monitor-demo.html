<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVO Payment - Blockchain Monitor Demo</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 25px;
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .status-card h3 {
            border-bottom-color: rgba(255,255,255,0.3);
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #46C16D;
        }
        
        .btn-danger {
            background: #D7272B;
        }
        
        .btn-warning {
            background: #DD6B20;
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-monitoring {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-found {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .payment-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            position: relative;
        }
        
        .payment-item.monitoring {
            border-left: 4px solid #DD6B20;
            background: #fff8f0;
        }
        
        .payment-item.confirmed {
            border-left: 4px solid #46C16D;
            background: #f0fff4;
        }
        
        .payment-item.expired {
            border-left: 4px solid #D7272B;
            background: #fff5f5;
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .log-container {
            height: 250px;
            overflow-y: auto;
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .transaction-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .transaction-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
    
    <!-- 外部库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- 配置文件 -->
    <script src="./config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 EVO Payment Monitor Demo</h1>
            <p>区块链交易监听和支付验证功能演示</p>
        </div>
        
        <div class="demo-grid">
            <!-- 监听状态 -->
            <div class="card status-card">
                <h3>📊 监听状态</h3>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="activeMonitoring">0</div>
                        <div class="stat-label">活跃监听</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalPayments">0</div>
                        <div class="stat-label">总支付数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedPayments">0</div>
                        <div class="stat-label">已完成</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pollingInterval">5s</div>
                        <div class="stat-label">轮询间隔</div>
                    </div>
                </div>
                
                <button id="refreshStats" class="btn">刷新统计</button>
                <button id="stopAllMonitoring" class="btn btn-danger">停止所有监听</button>
            </div>
            
            <!-- 创建测试支付 -->
            <div class="card">
                <h3>💳 创建测试支付</h3>
                
                <div class="form-group">
                    <label for="testAmount">支付金额 (USD)</label>
                    <input type="number" id="testAmount" value="1.0" min="0.01" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="testToken">代币类型</label>
                    <select id="testToken">
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                        <option value="BUSD">BUSD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="testUserAddress">用户地址</label>
                    <input type="text" id="testUserAddress" placeholder="0x..." value="0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6">
                </div>
                
                <button id="createTestPayment" class="btn">创建测试支付</button>
                <button id="createAndMonitor" class="btn btn-success">创建并开始监听</button>
                
                <div id="testPaymentResult" class="info-display hidden"></div>
            </div>
            
            <!-- 监听控制 -->
            <div class="card">
                <h3>🎛️ 监听控制</h3>
                
                <div class="form-group">
                    <label for="monitorPaymentId">支付ID</label>
                    <input type="text" id="monitorPaymentId" placeholder="输入支付ID">
                </div>
                
                <div class="form-group">
                    <label for="monitorFromBlock">起始区块 (可选)</label>
                    <input type="number" id="monitorFromBlock" placeholder="留空使用最新区块">
                </div>
                
                <button id="startMonitoring" class="btn">开始监听</button>
                <button id="stopMonitoring" class="btn btn-secondary">停止监听</button>
                <button id="checkOnce" class="btn btn-warning">单次检查</button>
                
                <div id="monitoringStatus" class="status-indicator hidden"></div>
            </div>
            
            <!-- 模拟交易 -->
            <div class="card">
                <h3>🎭 模拟交易</h3>
                
                <div class="form-group">
                    <label for="simulatePaymentId">支付ID</label>
                    <input type="text" id="simulatePaymentId" placeholder="输入支付ID">
                </div>
                
                <div class="form-group">
                    <label for="simulateTxHash">模拟交易哈希</label>
                    <input type="text" id="simulateTxHash" placeholder="0x..." value="0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef">
                </div>
                
                <button id="simulatePaymentFound" class="btn btn-success">模拟找到支付</button>
                <button id="simulatePaymentExpired" class="btn btn-warning">模拟支付过期</button>
                <button id="simulatePaymentError" class="btn btn-danger">模拟支付错误</button>
                
                <div id="simulationResult" class="info-display hidden"></div>
            </div>
            
            <!-- 支付列表 -->
            <div class="card">
                <h3>📋 支付列表</h3>
                
                <div class="form-group">
                    <label for="paymentFilter">状态过滤</label>
                    <select id="paymentFilter">
                        <option value="">全部</option>
                        <option value="pending">待处理</option>
                        <option value="monitoring">监听中</option>
                        <option value="confirmed">已确认</option>
                        <option value="completed">已完成</option>
                        <option value="expired">已过期</option>
                        <option value="failed">失败</option>
                    </select>
                </div>
                
                <button id="refreshPaymentList" class="btn">刷新列表</button>
                <button id="clearAllPayments" class="btn btn-danger">清除所有</button>
                
                <div id="paymentList">
                    <!-- 支付列表将在这里显示 -->
                </div>
            </div>
            
            <!-- 交易详情 -->
            <div class="card">
                <h3>🔍 交易详情</h3>
                
                <div class="form-group">
                    <label for="txHashQuery">交易哈希</label>
                    <input type="text" id="txHashQuery" placeholder="0x...">
                </div>
                
                <button id="queryTransactionDetail" class="btn">查询详情</button>
                
                <div id="transactionDetail" class="info-display hidden"></div>
            </div>
            
            <!-- 实时日志 -->
            <div class="card">
                <h3>📝 实时日志</h3>
                
                <div id="realtimeLog" class="log-container">
                    <!-- 实时日志将在这里显示 -->
                </div>
                
                <button id="clearLog" class="btn btn-secondary">清除日志</button>
                <button id="exportLog" class="btn btn-secondary">导出日志</button>
            </div>
        </div>
    </div>
    
    <!-- 依赖脚本 -->
    <script src="./js/blockchain-connector.js"></script>
    <script src="./js/payment-handler.js"></script>
    <script src="./js/blockchain-monitor.js"></script>
    
    <!-- 演示脚本 -->
    <script>
        // DOM 元素
        const elements = {
            // 统计
            activeMonitoring: document.getElementById('activeMonitoring'),
            totalPayments: document.getElementById('totalPayments'),
            completedPayments: document.getElementById('completedPayments'),
            pollingInterval: document.getElementById('pollingInterval'),
            refreshStats: document.getElementById('refreshStats'),
            stopAllMonitoring: document.getElementById('stopAllMonitoring'),
            
            // 测试支付
            testAmount: document.getElementById('testAmount'),
            testToken: document.getElementById('testToken'),
            testUserAddress: document.getElementById('testUserAddress'),
            createTestPayment: document.getElementById('createTestPayment'),
            createAndMonitor: document.getElementById('createAndMonitor'),
            testPaymentResult: document.getElementById('testPaymentResult'),
            
            // 监听控制
            monitorPaymentId: document.getElementById('monitorPaymentId'),
            monitorFromBlock: document.getElementById('monitorFromBlock'),
            startMonitoring: document.getElementById('startMonitoring'),
            stopMonitoring: document.getElementById('stopMonitoring'),
            checkOnce: document.getElementById('checkOnce'),
            monitoringStatus: document.getElementById('monitoringStatus'),
            
            // 模拟交易
            simulatePaymentId: document.getElementById('simulatePaymentId'),
            simulateTxHash: document.getElementById('simulateTxHash'),
            simulatePaymentFound: document.getElementById('simulatePaymentFound'),
            simulatePaymentExpired: document.getElementById('simulatePaymentExpired'),
            simulatePaymentError: document.getElementById('simulatePaymentError'),
            simulationResult: document.getElementById('simulationResult'),
            
            // 支付列表
            paymentFilter: document.getElementById('paymentFilter'),
            refreshPaymentList: document.getElementById('refreshPaymentList'),
            clearAllPayments: document.getElementById('clearAllPayments'),
            paymentList: document.getElementById('paymentList'),
            
            // 交易详情
            txHashQuery: document.getElementById('txHashQuery'),
            queryTransactionDetail: document.getElementById('queryTransactionDetail'),
            transactionDetail: document.getElementById('transactionDetail'),
            
            // 日志
            realtimeLog: document.getElementById('realtimeLog'),
            clearLog: document.getElementById('clearLog'),
            exportLog: document.getElementById('exportLog')
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Blockchain Monitor Demo 初始化');
            
            // 绑定事件
            bindEvents();
            
            // 设置监听器事件
            setupMonitorEventListeners();
            
            // 初始化数据
            refreshStats();
            refreshPaymentList();
            
            logMessage('🚀 Blockchain Monitor Demo 已加载');
        });
        
        // 绑定事件
        function bindEvents() {
            // 统计
            elements.refreshStats.addEventListener('click', refreshStats);
            elements.stopAllMonitoring.addEventListener('click', stopAllMonitoring);
            
            // 测试支付
            elements.createTestPayment.addEventListener('click', createTestPayment);
            elements.createAndMonitor.addEventListener('click', createAndMonitor);
            
            // 监听控制
            elements.startMonitoring.addEventListener('click', startMonitoring);
            elements.stopMonitoring.addEventListener('click', stopMonitoring);
            elements.checkOnce.addEventListener('click', checkOnce);
            
            // 模拟交易
            elements.simulatePaymentFound.addEventListener('click', simulatePaymentFound);
            elements.simulatePaymentExpired.addEventListener('click', simulatePaymentExpired);
            elements.simulatePaymentError.addEventListener('click', simulatePaymentError);
            
            // 支付列表
            elements.refreshPaymentList.addEventListener('click', refreshPaymentList);
            elements.clearAllPayments.addEventListener('click', clearAllPayments);
            elements.paymentFilter.addEventListener('change', refreshPaymentList);
            
            // 交易详情
            elements.queryTransactionDetail.addEventListener('click', queryTransactionDetail);
            
            // 日志
            elements.clearLog.addEventListener('click', clearRealtimeLog);
            elements.exportLog.addEventListener('click', exportLog);
        }
        
        // 设置监听器事件
        function setupMonitorEventListeners() {
            // 监听开始
            window.addEventListener('monitoringStarted', (event) => {
                const { paymentId } = event.detail;
                logMessage(`🔍 开始监听支付: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // 监听停止
            window.addEventListener('monitoringStopped', (event) => {
                const { paymentId } = event.detail;
                logMessage(`⏹️ 停止监听支付: ${paymentId}`);
                refreshStats();
            });
            
            // 支付找到
            window.addEventListener('paymentFound', (event) => {
                const { paymentId, transaction } = event.detail;
                logMessage(`✅ 找到支付: ${paymentId} - ${transaction.hash}`);
                refreshPaymentList();
            });
            
            // 支付完成
            window.addEventListener('paymentCompleted', (event) => {
                const { paymentId, transaction } = event.detail;
                logMessage(`🎉 支付完成: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // 支付过期
            window.addEventListener('paymentExpired', (event) => {
                const { paymentId } = event.detail;
                logMessage(`⏰ 支付过期: ${paymentId}`);
                refreshStats();
                refreshPaymentList();
            });
            
            // 支付错误
            window.addEventListener('paymentError', (event) => {
                const { paymentId, error } = event.detail;
                logMessage(`❌ 支付错误: ${paymentId} - ${error.message}`);
                refreshStats();
                refreshPaymentList();
            });
        }
        
        // 刷新统计
        function refreshStats() {
            try {
                const monitorStats = window.BlockchainMonitor.getMonitoringStats();
                const paymentStats = window.PaymentHandler.getPaymentStats();
                
                elements.activeMonitoring.textContent = monitorStats.activeMonitoring;
                elements.totalPayments.textContent = paymentStats.total;
                elements.completedPayments.textContent = paymentStats.completed;
                elements.pollingInterval.textContent = (monitorStats.pollingInterval / 1000) + 's';
                
            } catch (error) {
                logMessage(`❌ 刷新统计失败: ${error.message}`);
            }
        }
        
        // 创建测试支付
        function createTestPayment() {
            try {
                const amount = parseFloat(elements.testAmount.value);
                const token = elements.testToken.value;
                const userAddress = elements.testUserAddress.value;
                
                if (!amount || amount <= 0) {
                    throw new Error('请输入有效金额');
                }
                
                if (!userAddress) {
                    throw new Error('请输入用户地址');
                }
                
                const payment = window.PaymentHandler.createPayment({
                    amount,
                    token,
                    userAddress
                });
                
                elements.testPaymentResult.textContent = JSON.stringify(payment, null, 2);
                elements.testPaymentResult.classList.remove('hidden');
                
                // 自动填充支付ID
                elements.monitorPaymentId.value = payment.paymentId;
                elements.simulatePaymentId.value = payment.paymentId;
                
                refreshStats();
                refreshPaymentList();
                
                logMessage(`✅ 创建测试支付: ${payment.paymentId}`);
                
            } catch (error) {
                alert('创建测试支付失败: ' + error.message);
                logMessage(`❌ 创建测试支付失败: ${error.message}`);
            }
        }
        
        // 创建并监听
        async function createAndMonitor() {
            try {
                // 先创建支付
                createTestPayment();
                
                // 等待一下再开始监听
                setTimeout(async () => {
                    const paymentId = elements.monitorPaymentId.value;
                    if (paymentId) {
                        await startMonitoringPayment(paymentId);
                    }
                }, 500);
                
            } catch (error) {
                logMessage(`❌ 创建并监听失败: ${error.message}`);
            }
        }
        
        // 开始监听
        async function startMonitoring() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('请输入支付ID');
                return;
            }
            
            await startMonitoringPayment(paymentId);
        }
        
        // 开始监听支付
        async function startMonitoringPayment(paymentId) {
            try {
                showLoading(elements.startMonitoring, '开始中...');
                
                const options = {};
                const fromBlock = elements.monitorFromBlock.value;
                if (fromBlock) {
                    options.fromBlock = parseInt(fromBlock);
                }
                
                await window.BlockchainMonitor.startMonitoring(paymentId, options);
                
                elements.monitoringStatus.textContent = `✅ 开始监听: ${paymentId}`;
                elements.monitoringStatus.className = 'status-indicator status-monitoring';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`🔍 开始监听: ${paymentId}`);
                
            } catch (error) {
                elements.monitoringStatus.textContent = `❌ 监听失败: ${error.message}`;
                elements.monitoringStatus.className = 'status-indicator status-error';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`❌ 开始监听失败: ${error.message}`);
                alert('开始监听失败: ' + error.message);
            } finally {
                hideLoading(elements.startMonitoring, '开始监听');
            }
        }
        
        // 停止监听
        function stopMonitoring() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('请输入支付ID');
                return;
            }
            
            try {
                window.BlockchainMonitor.stopMonitoring(paymentId);
                
                elements.monitoringStatus.textContent = `⏹️ 已停止监听: ${paymentId}`;
                elements.monitoringStatus.className = 'status-indicator';
                elements.monitoringStatus.classList.remove('hidden');
                
                logMessage(`⏹️ 停止监听: ${paymentId}`);
                
            } catch (error) {
                logMessage(`❌ 停止监听失败: ${error.message}`);
                alert('停止监听失败: ' + error.message);
            }
        }
        
        // 单次检查
        async function checkOnce() {
            const paymentId = elements.monitorPaymentId.value;
            if (!paymentId) {
                alert('请输入支付ID');
                return;
            }
            
            try {
                showLoading(elements.checkOnce, '检查中...');
                
                await window.BlockchainMonitor.checkPaymentTransaction(paymentId);
                
                logMessage(`🔍 单次检查完成: ${paymentId}`);
                
            } catch (error) {
                logMessage(`❌ 单次检查失败: ${error.message}`);
                alert('单次检查失败: ' + error.message);
            } finally {
                hideLoading(elements.checkOnce, '单次检查');
            }
        }
        
        // 停止所有监听
        function stopAllMonitoring() {
            if (confirm('确定要停止所有监听吗？')) {
                window.BlockchainMonitor.stopAllMonitoring();
                refreshStats();
                logMessage('🛑 已停止所有监听');
            }
        }
        
        // 模拟找到支付
        function simulatePaymentFound() {
            const paymentId = elements.simulatePaymentId.value;
            const txHash = elements.simulateTxHash.value;
            
            if (!paymentId || !txHash) {
                alert('请输入支付ID和交易哈希');
                return;
            }
            
            try {
                const mockTransaction = {
                    hash: txHash,
                    blockNumber: 12345678,
                    from: '0x1234567890123456789012345678901234567890',
                    to: window.EVO_CONFIG.APP_CONFIG.payment.receiverAddress,
                    value: '1000000000000000000', // 1 token
                    type: 'token_transfer'
                };
                
                window.BlockchainMonitor.handlePaymentFound(paymentId, mockTransaction);
                
                elements.simulationResult.textContent = `模拟找到支付成功:\n${JSON.stringify(mockTransaction, null, 2)}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`🎭 模拟找到支付: ${paymentId}`);
                
            } catch (error) {
                logMessage(`❌ 模拟找到支付失败: ${error.message}`);
                alert('模拟失败: ' + error.message);
            }
        }
        
        // 模拟支付过期
        function simulatePaymentExpired() {
            const paymentId = elements.simulatePaymentId.value;
            
            if (!paymentId) {
                alert('请输入支付ID');
                return;
            }
            
            try {
                window.BlockchainMonitor.handlePaymentExpired(paymentId);
                
                elements.simulationResult.textContent = `模拟支付过期成功: ${paymentId}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`🎭 模拟支付过期: ${paymentId}`);
                
            } catch (error) {
                logMessage(`❌ 模拟支付过期失败: ${error.message}`);
                alert('模拟失败: ' + error.message);
            }
        }
        
        // 模拟支付错误
        function simulatePaymentError() {
            const paymentId = elements.simulatePaymentId.value;
            
            if (!paymentId) {
                alert('请输入支付ID');
                return;
            }
            
            try {
                const mockError = new Error('模拟的网络错误');
                window.BlockchainMonitor.handlePaymentError(paymentId, mockError);
                
                elements.simulationResult.textContent = `模拟支付错误成功: ${paymentId}\n错误: ${mockError.message}`;
                elements.simulationResult.classList.remove('hidden');
                
                logMessage(`🎭 模拟支付错误: ${paymentId}`);
                
            } catch (error) {
                logMessage(`❌ 模拟支付错误失败: ${error.message}`);
                alert('模拟失败: ' + error.message);
            }
        }
        
        // 刷新支付列表
        function refreshPaymentList() {
            try {
                const filter = elements.paymentFilter.value;
                const filters = filter ? { status: filter } : {};
                const payments = window.PaymentHandler.getAllPayments(filters);
                
                elements.paymentList.innerHTML = '';
                
                if (payments.length === 0) {
                    elements.paymentList.innerHTML = '<p style="text-align: center; color: #666;">暂无支付记录</p>';
                    return;
                }
                
                payments.forEach(payment => {
                    const item = document.createElement('div');
                    item.className = `payment-item ${payment.status}`;
                    
                    const isMonitoring = window.BlockchainMonitor.activePayments.has(payment.paymentId);
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${payment.paymentId}</strong>
                            <span class="status-indicator status-${payment.status}" style="padding: 2px 8px; font-size: 12px;">
                                ${payment.status.toUpperCase()}
                                ${isMonitoring ? ' (监听中)' : ''}
                            </span>
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            <p>💰 金额: $${payment.amount} ${payment.tokenSymbol}</p>
                            <p>📅 创建: ${payment.createdAt.toLocaleString()}</p>
                            <p>⏰ 过期: ${payment.expiresAt.toLocaleString()}</p>
                            ${payment.txHash ? `<p>🔗 交易: ${payment.txHash.substring(0, 20)}...</p>` : ''}
                        </div>
                        <div class="payment-actions">
                            <button class="btn" onclick="startMonitoringFromList('${payment.paymentId}')" 
                                    ${isMonitoring || !['pending'].includes(payment.status) ? 'disabled' : ''}>
                                开始监听
                            </button>
                            <button class="btn btn-secondary" onclick="stopMonitoringFromList('${payment.paymentId}')"
                                    ${!isMonitoring ? 'disabled' : ''}>
                                停止监听
                            </button>
                            <button class="btn btn-warning" onclick="checkPaymentFromList('${payment.paymentId}')">
                                检查状态
                            </button>
                        </div>
                    `;
                    
                    elements.paymentList.appendChild(item);
                });
                
            } catch (error) {
                logMessage(`❌ 刷新支付列表失败: ${error.message}`);
            }
        }
        
        // 从列表开始监听
        window.startMonitoringFromList = async function(paymentId) {
            elements.monitorPaymentId.value = paymentId;
            await startMonitoringPayment(paymentId);
        };
        
        // 从列表停止监听
        window.stopMonitoringFromList = function(paymentId) {
            window.BlockchainMonitor.stopMonitoring(paymentId);
            refreshPaymentList();
        };
        
        // 从列表检查支付
        window.checkPaymentFromList = async function(paymentId) {
            try {
                await window.BlockchainMonitor.checkPaymentTransaction(paymentId);
                refreshPaymentList();
                logMessage(`🔍 检查支付状态: ${paymentId}`);
            } catch (error) {
                logMessage(`❌ 检查支付状态失败: ${error.message}`);
            }
        };
        
        // 清除所有支付
        function clearAllPayments() {
            if (confirm('确定要清除所有支付记录吗？')) {
                window.PaymentHandler.payments.clear();
                window.BlockchainMonitor.stopAllMonitoring();
                refreshStats();
                refreshPaymentList();
                logMessage('🗑️ 已清除所有支付记录');
            }
        }
        
        // 查询交易详情
        async function queryTransactionDetail() {
            const txHash = elements.txHashQuery.value;
            
            if (!txHash) {
                alert('请输入交易哈希');
                return;
            }
            
            try {
                showLoading(elements.queryTransactionDetail, '查询中...');
                
                const txInfo = await window.BlockchainConnector.getTransaction(txHash);
                
                elements.transactionDetail.textContent = JSON.stringify(txInfo, null, 2);
                elements.transactionDetail.classList.remove('hidden');
                
                logMessage(`🔍 查询交易详情: ${txHash.substring(0, 20)}...`);
                
            } catch (error) {
                elements.transactionDetail.textContent = `查询失败: ${error.message}`;
                elements.transactionDetail.classList.remove('hidden');
                
                logMessage(`❌ 查询交易详情失败: ${error.message}`);
            } finally {
                hideLoading(elements.queryTransactionDetail, '查询详情');
            }
        }
        
        // 清除日志
        function clearRealtimeLog() {
            elements.realtimeLog.textContent = '';
        }
        
        // 导出日志
        function exportLog() {
            const logContent = elements.realtimeLog.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitor-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            logMessage('📥 日志已导出');
        }
        
        // 记录日志
        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            elements.realtimeLog.textContent += logEntry;
            
            // 自动滚动到底部
            elements.realtimeLog.scrollTop = elements.realtimeLog.scrollHeight;
            
            // 限制日志长度
            const lines = elements.realtimeLog.textContent.split('\n');
            if (lines.length > 200) {
                elements.realtimeLog.textContent = lines.slice(-200).join('\n');
            }
        }
        
        // 工具函数
        function showLoading(button, text) {
            button.innerHTML = `<span class="loading"></span> ${text}`;
            button.disabled = true;
        }
        
        function hideLoading(button, text) {
            button.innerHTML = text;
            button.disabled = false;
        }
        
        // 页面加载完成
        window.addEventListener('load', function() {
            logMessage('🚀 Blockchain Monitor Demo 已加载');
            logMessage('💡 提示: 创建测试支付并开始监听体验功能');
        });
    </script>
</body>
</html>