<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket æ”¯ä»˜æµç¨‹è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .debug-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        .debug-button:hover {
            background: #0056b3;
        }
        .success-button {
            background: #28a745;
        }
        .success-button:hover {
            background: #1e7e34;
        }
        .warning-button {
            background: #ffc107;
            color: #212529;
        }
        .warning-button:hover {
            background: #e0a800;
        }
        .error-button {
            background: #dc3545;
        }
        .error-button:hover {
            background: #c82333;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log-entry {
            margin-bottom: 3px;
            padding: 1px 0;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
        .log-info {
            color: #007bff;
        }
        .log-warning {
            color: #ffc107;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-item {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .status-label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
        }
        .status-value {
            font-size: 14px;
            color: #333;
            margin-top: 5px;
        }
        .flow-step {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #dee2e6;
            background: #f8f9fa;
        }
        .flow-step.active {
            border-left-color: #007bff;
            background: #e3f2fd;
        }
        .flow-step.success {
            border-left-color: #28a745;
            background: #e8f5e8;
        }
        .flow-step.error {
            border-left-color: #dc3545;
            background: #ffeaea;
        }
    </style>
</head>
<body>
    <h1>WebSocket æ”¯ä»˜æµç¨‹è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
        <div class="status-grid">
            <div class="status-item">
                <div class="status-label">åŒºå—é“¾ç®¡ç†å™¨</div>
                <div class="status-value" id="blockchain-manager-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">WebSocket ç›‘å¬å™¨</div>
                <div class="status-value" id="websocket-monitor-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ”¯ä»˜å¤„ç†å™¨</div>
                <div class="status-value" id="payment-handler-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ”¯ä»˜ç›‘å¬å™¨</div>
                <div class="status-value" id="payment-listener-status">æ£€æŸ¥ä¸­...</div>
            </div>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="debug-button" onclick="checkSystemStatus()">ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <button class="debug-button" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»ç»Ÿ</button>
        </div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">æ”¯ä»˜æµç¨‹æµ‹è¯•</h2>
        <div id="flow-steps">
            <div class="flow-step" id="step-1">1. åˆ›å»ºæ”¯ä»˜æ•°æ®</div>
            <div class="flow-step" id="step-2">2. åˆå§‹åŒ–æ”¯ä»˜ç›‘å¬å™¨</div>
            <div class="flow-step" id="step-3">3. å¯åŠ¨ WebSocket ç›‘å¬</div>
            <div class="flow-step" id="step-4">4. æ¨¡æ‹Ÿ Transfer äº‹ä»¶</div>
            <div class="flow-step" id="step-5">5. éªŒè¯æ”¯ä»˜åŒ¹é…</div>
            <div class="flow-step" id="step-6">6. è§¦å‘æˆåŠŸå›è°ƒ</div>
            <div class="flow-step" id="step-7">7. è·³è½¬åˆ°æˆåŠŸé¡µé¢</div>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="success-button" onclick="testCompleteFlow()">ğŸ§ª æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <button class="debug-button" onclick="testStepByStep()">ğŸ“‹ é€æ­¥æµ‹è¯•</button>
            <button class="warning-button" onclick="simulateTransferEvent()">ğŸ’° æ¨¡æ‹Ÿ Transfer äº‹ä»¶</button>
            <button class="error-button" onclick="forceJumpToSuccess()">ğŸš€ å¼ºåˆ¶è·³è½¬æˆåŠŸé¡µ</button>
        </div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">è°ƒè¯•æ—¥å¿—</h2>
        <div class="log-container" id="log-container">
            <div class="log-entry log-info">è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œç­‰å¾…æµ‹è¯•...</div>
        </div>
        <button class="debug-button" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <button class="debug-button" onclick="exportLog()">ğŸ“„ å¯¼å‡ºæ—¥å¿—</button>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="../config.js"></script>
    <script src="../lib/web3.min.js"></script>
    <script src="../js/blockchain-ws.js"></script>
    <script src="../js/payment-handler-ws.js"></script>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function exportLog() {
            const logContainer = document.getElementById('log-container');
            const logs = Array.from(logContainer.children).map(entry => entry.textContent).join('\\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `websocket-debug-${Date.now()}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // çŠ¶æ€æ›´æ–°
        function updateStatus(elementId, status, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = status;
                element.style.color = type === 'success' ? '#28a745' : 
                                    type === 'error' ? '#dc3545' : 
                                    type === 'warning' ? '#ffc107' : '#333';
            }
        }

        function updateFlowStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `flow-step ${status}`;
            }
        }

        // ç³»ç»Ÿæ£€æŸ¥
        function checkSystemStatus() {
            log('å¼€å§‹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...', 'info');
            
            // æ£€æŸ¥åŒºå—é“¾ç®¡ç†å™¨
            if (typeof window.blockchainManager !== 'undefined') {
                updateStatus('blockchain-manager-status', 'âœ… å·²åŠ è½½', 'success');
                log('åŒºå—é“¾ç®¡ç†å™¨: å·²åŠ è½½', 'success');
            } else {
                updateStatus('blockchain-manager-status', 'âŒ æœªåŠ è½½', 'error');
                log('åŒºå—é“¾ç®¡ç†å™¨: æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥ WebSocket ç›‘å¬å™¨
            if (typeof window.webSocketMonitor !== 'undefined') {
                updateStatus('websocket-monitor-status', 'âœ… å·²åŠ è½½', 'success');
                log('WebSocket ç›‘å¬å™¨: å·²åŠ è½½', 'success');
            } else {
                updateStatus('websocket-monitor-status', 'âŒ æœªåŠ è½½', 'error');
                log('WebSocket ç›‘å¬å™¨: æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥æ”¯ä»˜å¤„ç†å™¨
            if (typeof window.paymentHandler !== 'undefined') {
                updateStatus('payment-handler-status', 'âœ… å·²åŠ è½½', 'success');
                log('æ”¯ä»˜å¤„ç†å™¨: å·²åŠ è½½', 'success');
            } else {
                updateStatus('payment-handler-status', 'âŒ æœªåŠ è½½', 'error');
                log('æ”¯ä»˜å¤„ç†å™¨: æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥æ”¯ä»˜ç›‘å¬å™¨ç±»
            if (typeof window.PaymentListenerWS !== 'undefined') {
                updateStatus('payment-listener-status', 'âœ… ç±»å·²å®šä¹‰', 'success');
                log('æ”¯ä»˜ç›‘å¬å™¨ç±»: å·²å®šä¹‰', 'success');
            } else {
                updateStatus('payment-listener-status', 'âŒ ç±»æœªå®šä¹‰', 'error');
                log('æ”¯ä»˜ç›‘å¬å™¨ç±»: æœªå®šä¹‰', 'error');
            }
        }

        function initializeSystem() {
            log('å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...', 'info');
            
            try {
                // åˆå§‹åŒ–åŒºå—é“¾ç®¡ç†å™¨
                if (typeof window.BlockchainManagerWS !== 'undefined') {
                    if (!window.blockchainManager) {
                        window.blockchainManager = new window.BlockchainManagerWS();
                        log('åŒºå—é“¾ç®¡ç†å™¨å·²åˆå§‹åŒ–', 'success');
                    }
                }

                // åˆå§‹åŒ–æ”¯ä»˜å¤„ç†å™¨
                if (typeof window.PaymentHandlerWS !== 'undefined') {
                    if (!window.paymentHandler) {
                        window.paymentHandler = new window.PaymentHandlerWS();
                        log('æ”¯ä»˜å¤„ç†å™¨å·²åˆå§‹åŒ–', 'success');
                    }
                }

                log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
                checkSystemStatus();

            } catch (error) {
                log(`ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµç¨‹æµ‹è¯•
        function testCompleteFlow() {
            log('å¼€å§‹æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹...', 'info');
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 7; i++) {
                updateFlowStep(`step-${i}`, '');
            }

            let currentStep = 1;

            const executeStep = (stepNum, stepName, stepFunction) => {
                if (currentStep === stepNum) {
                    updateFlowStep(`step-${stepNum}`, 'active');
                    log(`æ‰§è¡Œæ­¥éª¤ ${stepNum}: ${stepName}`, 'info');
                    
                    try {
                        const result = stepFunction();
                        if (result !== false) {
                            updateFlowStep(`step-${stepNum}`, 'success');
                            currentStep++;
                            
                            // ç»§ç»­ä¸‹ä¸€æ­¥
                            setTimeout(() => {
                                if (currentStep <= 7) {
                                    executeNextStep();
                                }
                            }, 1000);
                        } else {
                            updateFlowStep(`step-${stepNum}`, 'error');
                            log(`æ­¥éª¤ ${stepNum} å¤±è´¥`, 'error');
                        }
                    } catch (error) {
                        updateFlowStep(`step-${stepNum}`, 'error');
                        log(`æ­¥éª¤ ${stepNum} å¼‚å¸¸: ${error.message}`, 'error');
                    }
                }
            };

            const executeNextStep = () => {
                switch (currentStep) {
                    case 1:
                        executeStep(1, 'åˆ›å»ºæ”¯ä»˜æ•°æ®', createTestPaymentData);
                        break;
                    case 2:
                        executeStep(2, 'åˆå§‹åŒ–æ”¯ä»˜ç›‘å¬å™¨', initializePaymentListener);
                        break;
                    case 3:
                        executeStep(3, 'å¯åŠ¨ WebSocket ç›‘å¬', startWebSocketListening);
                        break;
                    case 4:
                        executeStep(4, 'æ¨¡æ‹Ÿ Transfer äº‹ä»¶', simulateTransferEvent);
                        break;
                    case 5:
                        executeStep(5, 'éªŒè¯æ”¯ä»˜åŒ¹é…', verifyPaymentMatch);
                        break;
                    case 6:
                        executeStep(6, 'è§¦å‘æˆåŠŸå›è°ƒ', triggerSuccessCallback);
                        break;
                    case 7:
                        executeStep(7, 'è·³è½¬åˆ°æˆåŠŸé¡µé¢', jumpToSuccessPage);
                        break;
                }
            };

            executeNextStep();
        }

        // æ­¥éª¤å®ç°
        function createTestPaymentData() {
            const paymentData = {
                paymentId: 'debug_test_' + Date.now(),
                product: 'rice',
                price: 10.00,
                selectedPayment: { symbol: 'USDT', name: 'Tether USD' },
                selectedNetwork: { symbol: 'BSC', name: 'BNB Smart Chain' },
                timestamp: Date.now(),
                expiresAt: Date.now() + 30 * 60 * 1000,
                status: 'waiting'
            };

            sessionStorage.setItem('paymentData', JSON.stringify(paymentData));
            window.testPaymentData = paymentData;
            log(`æ”¯ä»˜æ•°æ®å·²åˆ›å»º: ${paymentData.paymentId}`, 'success');
            return true;
        }

        function initializePaymentListener() {
            if (typeof window.PaymentListenerWS === 'undefined') {
                log('PaymentListenerWS ç±»æœªå®šä¹‰', 'error');
                return false;
            }

            window.testPaymentListener = new window.PaymentListenerWS();
            log('æ”¯ä»˜ç›‘å¬å™¨å·²åˆå§‹åŒ–', 'success');
            return true;
        }

        function startWebSocketListening() {
            if (!window.testPaymentListener || !window.testPaymentData) {
                log('æ”¯ä»˜ç›‘å¬å™¨æˆ–æ”¯ä»˜æ•°æ®æœªå‡†å¤‡å¥½', 'error');
                return false;
            }

            // æ¨¡æ‹Ÿå¯åŠ¨ç›‘å¬
            log('WebSocket ç›‘å¬å·²å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿï¼‰', 'success');
            return true;
        }

        function simulateTransferEvent() {
            log('æ¨¡æ‹Ÿ Transfer äº‹ä»¶...', 'info');
            
            const transferData = {
                transactionHash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                blockNumber: 12345678,
                tokenSymbol: 'USDT',
                fromAddress: '0x1111111111111111111111111111111111111111',
                toAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                amount: 10.00,
                amountWei: '10000000000000000000'
            };

            window.testTransferData = transferData;
            log(`Transfer äº‹ä»¶å·²æ¨¡æ‹Ÿ: ${transferData.amount} ${transferData.tokenSymbol}`, 'success');
            return true;
        }

        function verifyPaymentMatch() {
            if (!window.testPaymentData || !window.testTransferData) {
                log('æ”¯ä»˜æ•°æ®æˆ–è½¬è´¦æ•°æ®æœªå‡†å¤‡å¥½', 'error');
                return false;
            }

            // æ¨¡æ‹ŸåŒ¹é…éªŒè¯
            const isMatch = window.testPaymentData.price === window.testTransferData.amount &&
                           window.testPaymentData.selectedPayment.symbol === window.testTransferData.tokenSymbol;

            if (isMatch) {
                log('æ”¯ä»˜åŒ¹é…éªŒè¯é€šè¿‡', 'success');
                return true;
            } else {
                log('æ”¯ä»˜åŒ¹é…éªŒè¯å¤±è´¥', 'error');
                return false;
            }
        }

        function triggerSuccessCallback() {
            log('è§¦å‘æˆåŠŸå›è°ƒ...', 'info');
            
            const confirmationData = {
                paymentId: window.testPaymentData.paymentId,
                transfer: window.testTransferData,
                confirmations: 1,
                detectionTime: 2500,
                verificationResult: {
                    verified: true,
                    matchScore: 100
                }
            };

            // æ¨¡æ‹ŸæˆåŠŸå›è°ƒ
            setTimeout(() => {
                log('æˆåŠŸå›è°ƒå·²è§¦å‘', 'success');
                window.testConfirmationData = confirmationData;
            }, 500);

            return true;
        }

        function jumpToSuccessPage() {
            log('å‡†å¤‡è·³è½¬åˆ°æˆåŠŸé¡µé¢...', 'info');
            
            // æ›´æ–°æ”¯ä»˜æ•°æ®
            if (window.testPaymentData && window.testConfirmationData) {
                window.testPaymentData.status = 'confirmed';
                window.testPaymentData.confirmedAt = Date.now();
                window.testPaymentData.performanceMetrics = {
                    detectionTime: 2500,
                    detectionMethod: 'WebSocket'
                };
                
                sessionStorage.setItem('paymentData', JSON.stringify(window.testPaymentData));
            }

            // å»¶è¿Ÿè·³è½¬
            setTimeout(() => {
                log('è·³è½¬åˆ°æˆåŠŸé¡µé¢', 'success');
                window.location.href = '../success-ws.html';
            }, 1000);

            return true;
        }

        function testStepByStep() {
            log('å¼€å§‹é€æ­¥æµ‹è¯•...', 'info');
            // è¿™é‡Œå¯ä»¥å®ç°é€æ­¥æµ‹è¯•é€»è¾‘
            alert('é€æ­¥æµ‹è¯•åŠŸèƒ½å¾…å®ç°');
        }

        function forceJumpToSuccess() {
            log('å¼ºåˆ¶è·³è½¬åˆ°æˆåŠŸé¡µé¢...', 'warning');
            
            // åˆ›å»ºæœ€å°çš„æˆåŠŸæ•°æ®
            const successData = {
                paymentId: 'force_jump_' + Date.now(),
                product: 'rice',
                price: 10.00,
                selectedPayment: { symbol: 'USDT', name: 'Tether USD' },
                selectedNetwork: { symbol: 'BSC', name: 'BNB Smart Chain' },
                status: 'confirmed',
                confirmedAt: Date.now(),
                performanceMetrics: {
                    detectionTime: 1000,
                    detectionMethod: 'WebSocket'
                }
            };

            sessionStorage.setItem('paymentData', JSON.stringify(successData));
            
            setTimeout(() => {
                window.location.href = '../success-ws.html';
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('WebSocket æ”¯ä»˜æµç¨‹è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            
            // å»¶è¿Ÿæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html>