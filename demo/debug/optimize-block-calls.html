<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimize Block Number Calls</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .optimization {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ä¼˜åŒ–åŒºå—å·APIè°ƒç”¨</h1>
        <p>åˆ†æä¸ºä»€ä¹ˆéœ€è¦eth_blockNumberè°ƒç”¨ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–</p>
        
        <div class="section">
            <h3>ğŸ” å½“å‰å®ç°åˆ†æ</h3>
            <p><strong>ä¸ºä»€ä¹ˆéœ€è¦ eth_blockNumber è°ƒç”¨ï¼š</strong></p>
            <ul>
                <li>è®¡ç®—äº¤æ˜“ç¡®è®¤æ•°ï¼š<code>ç¡®è®¤æ•° = å½“å‰åŒºå—å· - äº¤æ˜“åŒºå—å·</code></li>
                <li>éªŒè¯æ˜¯å¦æ»¡è¶³æ‰€éœ€ç¡®è®¤æ•°</li>
                <li>æä¾›å‡†ç¡®çš„ç¡®è®¤çŠ¶æ€æ—¥å¿—</li>
            </ul>
            
            <div class="code-block">
// å½“å‰å®ç°
async confirmPayment(paymentId, transfer, monitor, matchResult = null) {
    // æ€»æ˜¯è·å–å½“å‰åŒºå—å·
    const currentBlock = await this.web3.eth.getBlockNumber(); // APIè°ƒç”¨
    const confirmations = currentBlock - transfer.blockNumber;
    
    const requiredConfirmations = monitor.requiredConfirmations !== undefined 
        ? monitor.requiredConfirmations : 1;
    
    if (confirmations >= requiredConfirmations) {
        // ç¡®è®¤æ”¯ä»˜
    }
}
            </div>
        </div>
        
        <div class="section">
            <h3>âš¡ ä¼˜åŒ–æ–¹æ¡ˆ</h3>
            <div class="optimization">
                <h4>æ–¹æ¡ˆ1ï¼š0ç¡®è®¤æ—¶è·³è¿‡APIè°ƒç”¨</h4>
                <div class="code-block">
// ä¼˜åŒ–åçš„å®ç°
async confirmPayment(paymentId, transfer, monitor, matchResult = null) {
    const requiredConfirmations = monitor.requiredConfirmations !== undefined 
        ? monitor.requiredConfirmations : 1;
    
    if (requiredConfirmations === 0) {
        // 0ç¡®è®¤æ¨¡å¼ï¼šç›´æ¥ç¡®è®¤ï¼Œæ— éœ€APIè°ƒç”¨
        console.log(`ğŸ“Š [BlockchainWS] Payment confirmations: 0/0 (instant)`);
        // ç›´æ¥ç¡®è®¤æ”¯ä»˜...
    } else {
        // éœ€è¦ç¡®è®¤æ•°ï¼šè·å–å½“å‰åŒºå—å·
        const currentBlock = await this.web3.eth.getBlockNumber(); // ä»…åœ¨éœ€è¦æ—¶è°ƒç”¨
        const confirmations = currentBlock - transfer.blockNumber;
        
        if (confirmations >= requiredConfirmations) {
            // ç¡®è®¤æ”¯ä»˜
        }
    }
}
                </div>
                <p><strong>ä¼˜ç‚¹ï¼š</strong>0ç¡®è®¤æ¨¡å¼ä¸‹å®Œå…¨é¿å…APIè°ƒç”¨ï¼Œæé«˜å“åº”é€Ÿåº¦</p>
            </div>
            
            <div class="optimization">
                <h4>æ–¹æ¡ˆ2ï¼šç¼“å­˜åŒºå—å·</h4>
                <div class="code-block">
// ç¼“å­˜å®ç°
class BlockchainManager {
    constructor() {
        this.cachedBlockNumber = null;
        this.blockCacheTime = 0;
        this.BLOCK_CACHE_TTL = 5000; // 5ç§’ç¼“å­˜
    }
    
    async getCurrentBlockNumber() {
        const now = Date.now();
        if (this.cachedBlockNumber && (now - this.blockCacheTime) < this.BLOCK_CACHE_TTL) {
            return this.cachedBlockNumber; // ä½¿ç”¨ç¼“å­˜
        }
        
        this.cachedBlockNumber = await this.web3.eth.getBlockNumber(); // APIè°ƒç”¨
        this.blockCacheTime = now;
        return this.cachedBlockNumber;
    }
}
                </div>
                <p><strong>ä¼˜ç‚¹ï¼š</strong>å‡å°‘é‡å¤APIè°ƒç”¨ï¼Œé€‚ç”¨äºçŸ­æ—¶é—´å†…å¤šæ¬¡ç¡®è®¤</p>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š æ€§èƒ½å¯¹æ¯”</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background-color: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 8px;">æ–¹æ¡ˆ</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">APIè°ƒç”¨æ¬¡æ•°</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">å“åº”æ—¶é—´</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">é€‚ç”¨åœºæ™¯</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">å½“å‰å®ç°</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">æ¯æ¬¡ç¡®è®¤1æ¬¡</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~200ms</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">é€šç”¨</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">0ç¡®è®¤ä¼˜åŒ–</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">0æ¬¡ï¼ˆ0ç¡®è®¤æ—¶ï¼‰</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~1ms</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">å³æ—¶æ”¯ä»˜</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">ç¼“å­˜ä¼˜åŒ–</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">5ç§’å†…1æ¬¡</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~1msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">é«˜é¢‘äº¤æ˜“</td>
                </tr>
            </table>
        </div>
        
        <div class="section">
            <h3>ğŸ’¡ æ¨èæ–¹æ¡ˆ</h3>
            <p>å¯¹äºä½ çš„ç”¨ä¾‹ï¼ˆå°é¢å³æ—¶æ”¯ä»˜ï¼‰ï¼Œæ¨èä½¿ç”¨<strong>æ–¹æ¡ˆ1ï¼š0ç¡®è®¤æ—¶è·³è¿‡APIè°ƒç”¨</strong></p>
            <p><strong>ç†ç”±ï¼š</strong></p>
            <ul>
                <li>ä½ çš„åº”ç”¨ä¸»è¦ä½¿ç”¨0ç¡®è®¤æ¨¡å¼</li>
                <li>å¯ä»¥å®Œå…¨é¿å…ä¸å¿…è¦çš„APIè°ƒç”¨</li>
                <li>æé«˜æ”¯ä»˜ç¡®è®¤é€Ÿåº¦</li>
                <li>å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒ</li>
            </ul>
        </div>
    </div>
</body>
</html>