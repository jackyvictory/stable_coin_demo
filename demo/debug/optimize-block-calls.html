<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimize Block Number Calls</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .optimization {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>优化区块号API调用</h1>
        <p>分析为什么需要eth_blockNumber调用，以及如何优化</p>
        
        <div class="section">
            <h3>🔍 当前实现分析</h3>
            <p><strong>为什么需要 eth_blockNumber 调用：</strong></p>
            <ul>
                <li>计算交易确认数：<code>确认数 = 当前区块号 - 交易区块号</code></li>
                <li>验证是否满足所需确认数</li>
                <li>提供准确的确认状态日志</li>
            </ul>
            
            <div class="code-block">
// 当前实现
async confirmPayment(paymentId, transfer, monitor, matchResult = null) {
    // 总是获取当前区块号
    const currentBlock = await this.web3.eth.getBlockNumber(); // API调用
    const confirmations = currentBlock - transfer.blockNumber;
    
    const requiredConfirmations = monitor.requiredConfirmations !== undefined 
        ? monitor.requiredConfirmations : 1;
    
    if (confirmations >= requiredConfirmations) {
        // 确认支付
    }
}
            </div>
        </div>
        
        <div class="section">
            <h3>⚡ 优化方案</h3>
            <div class="optimization">
                <h4>方案1：0确认时跳过API调用</h4>
                <div class="code-block">
// 优化后的实现
async confirmPayment(paymentId, transfer, monitor, matchResult = null) {
    const requiredConfirmations = monitor.requiredConfirmations !== undefined 
        ? monitor.requiredConfirmations : 1;
    
    if (requiredConfirmations === 0) {
        // 0确认模式：直接确认，无需API调用
        console.log(`📊 [BlockchainWS] Payment confirmations: 0/0 (instant)`);
        // 直接确认支付...
    } else {
        // 需要确认数：获取当前区块号
        const currentBlock = await this.web3.eth.getBlockNumber(); // 仅在需要时调用
        const confirmations = currentBlock - transfer.blockNumber;
        
        if (confirmations >= requiredConfirmations) {
            // 确认支付
        }
    }
}
                </div>
                <p><strong>优点：</strong>0确认模式下完全避免API调用，提高响应速度</p>
            </div>
            
            <div class="optimization">
                <h4>方案2：缓存区块号</h4>
                <div class="code-block">
// 缓存实现
class BlockchainManager {
    constructor() {
        this.cachedBlockNumber = null;
        this.blockCacheTime = 0;
        this.BLOCK_CACHE_TTL = 5000; // 5秒缓存
    }
    
    async getCurrentBlockNumber() {
        const now = Date.now();
        if (this.cachedBlockNumber && (now - this.blockCacheTime) < this.BLOCK_CACHE_TTL) {
            return this.cachedBlockNumber; // 使用缓存
        }
        
        this.cachedBlockNumber = await this.web3.eth.getBlockNumber(); // API调用
        this.blockCacheTime = now;
        return this.cachedBlockNumber;
    }
}
                </div>
                <p><strong>优点：</strong>减少重复API调用，适用于短时间内多次确认</p>
            </div>
        </div>
        
        <div class="section">
            <h3>📊 性能对比</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background-color: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 8px;">方案</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">API调用次数</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">响应时间</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px;">适用场景</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">当前实现</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">每次确认1次</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~200ms</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">通用</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">0确认优化</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">0次（0确认时）</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~1ms</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">即时支付</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">缓存优化</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">5秒内1次</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">~1ms（缓存命中）</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">高频交易</td>
                </tr>
            </table>
        </div>
        
        <div class="section">
            <h3>💡 推荐方案</h3>
            <p>对于你的用例（小额即时支付），推荐使用<strong>方案1：0确认时跳过API调用</strong></p>
            <p><strong>理由：</strong></p>
            <ul>
                <li>你的应用主要使用0确认模式</li>
                <li>可以完全避免不必要的API调用</li>
                <li>提高支付确认速度</li>
                <li>减少网络请求，提升用户体验</li>
            </ul>
        </div>
    </div>
</body>
</html>