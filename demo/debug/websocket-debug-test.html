<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        .status-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        .status-value {
            color: #007bff;
            font-size: 14px;
        }
        .debug-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .control-buttons {
            margin: 10px 0;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Debug Test Page</h1>
        <p>此页面用于测试WebSocket调试功能，验证消息记录和显示是否正常工作。</p>
        
        <!-- WebSocket状态信息 -->
        <div class="debug-section">
            <h3>🔌 WebSocket Status</h3>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-label">Connection Status</div>
                    <div class="status-value" id="ws-connection-status">Checking...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Current Endpoint</div>
                    <div class="status-value" id="ws-current-endpoint">Loading...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Available Endpoints</div>
                    <div class="status-value" id="ws-backup-endpoints">Loading...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Messages Matched</div>
                    <div class="status-value" id="ws-messages-matched">0</div>
                </div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" id="ws-main-control-button" onclick="handleWebSocketControl()">🔌 Connect</button>
                <button class="btn btn-secondary" onclick="toggleWebSocketDebugInfo()">📊 Toggle Debug Info</button>
                <button class="btn btn-warning" onclick="clearWebSocketDebugMessages()">🗑️ Clear Messages</button>
                <button class="btn btn-success" onclick="testWebSocketMessages()">🧪 Test Messages</button>
            </div>
        </div>
        
        <!-- 调试消息显示 -->
        <div class="debug-section">
            <h3>📊 Debug Messages</h3>
            <div id="ws-debug-messages" style="display: block;">
                <div class="debug-messages" id="ws-debug-content">
                    <div style="color: #6c757d; font-style: italic;">WebSocket messages will appear here...</div>
                </div>
            </div>
        </div>
        
        <!-- 测试控制 -->
        <div class="debug-section">
            <h3>🧪 Test Controls</h3>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="simulateConnection()">🔌 Simulate Connection</button>
                <button class="btn btn-success" onclick="simulateMessage()">📨 Simulate Message</button>
                <button class="btn btn-warning" onclick="simulateHeartbeat()">💓 Simulate Heartbeat</button>
                <button class="btn btn-danger" onclick="simulateError()">❌ Simulate Error</button>
                <button class="btn btn-secondary" onclick="simulateBlock()">🧱 Simulate Block</button>
            </div>
            <div class="control-buttons">
                <button class="btn btn-danger" onclick="simulateConnectionFailure()">🔴 Simulate Connection Failure</button>
                <button class="btn btn-warning" onclick="simulateHeartbeatSequence()">🫀 Simulate Heartbeat Sequence</button>
            </div>
            <div class="control-buttons">
                <button class="btn btn-warning" onclick="simulateDisconnect()">🔴 Simulate Disconnect</button>
                <button class="btn btn-primary" onclick="simulateReconnect()">🟢 Simulate Reconnect</button>
                <button class="btn btn-secondary" onclick="simulatePaymentRestart()">🔄 Simulate Payment Restart</button>
            </div>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="../js/blockchain-manager.js"></script>
    <script src="../js/qrcode-ws.js"></script>
    
    <script>
        // 测试函数
        function testWebSocketMessages() {
            addWebSocketDebugMessage('Testing WebSocket debug system...', 'info');
            setTimeout(() => addWebSocketDebugMessage('Test message 1', 'success'), 500);
            setTimeout(() => addWebSocketDebugMessage('Test message 2', 'warning'), 1000);
            setTimeout(() => addWebSocketDebugMessage('Test message 3', 'error'), 1500);
        }
        
        function simulateConnection() {
            addWebSocketDebugMessage('Simulating WebSocket connection...', 'websocket', {
                endpoint: 'wss://test.example.com',
                attempt: 1
            });
        }
        
        function simulateMessage() {
            addWebSocketDebugMessage('Received WebSocket message', 'message', {
                type: 'eth_subscription',
                subscription: '0x123456',
                result: { number: '0x1234567' }
            });
        }
        
        function simulateHeartbeat() {
            addWebSocketDebugMessage('WebSocket heartbeat', 'heartbeat', {
                type: 'ping',
                timestamp: Date.now()
            });
        }
        
        function simulateError() {
            addWebSocketDebugMessage('WebSocket connection error', 'error', {
                code: 1006,
                reason: 'Connection lost'
            });
        }
        
        function simulateConnectionFailure() {
            addWebSocketDebugMessage('🔄 Attempting WebSocket connection...', 'websocket', {
                endpoints: 3,
                currentEndpoint: 0,
                availableEndpoints: [
                    { index: 0, name: 'Primary', url: 'wss://primary.example.com', status: '[Active]' },
                    { index: 1, name: 'Secondary', url: 'wss://secondary.example.com', status: '[Standby]' },
                    { index: 2, name: 'Backup', url: 'wss://backup.example.com', status: '[Standby]' }
                ]
            });
            
            setTimeout(() => {
                addWebSocketDebugMessage('🔴 Connection establishment failed', 'error', {
                    phase: 'Connection establishment',
                    endpoint: 'Primary',
                    possibleCauses: [
                        'Network connectivity issues',
                        'Endpoint server down',
                        'Firewall blocking connection',
                        'Invalid endpoint URL',
                        'SSL/TLS certificate issues'
                    ],
                    nextAction: 'Try next endpoint'
                });
            }, 1000);
            
            setTimeout(() => {
                addWebSocketDebugMessage('❌ All WebSocket endpoints failed', 'error', {
                    totalEndpoints: 3,
                    attemptedEndpoints: ['Primary', 'Secondary', 'Backup'],
                    connectionDuration: '5432ms',
                    lastAttemptedEndpoint: 'Backup',
                    possibleIssues: [
                        'All endpoints are down',
                        'Network connectivity problems', 
                        'Firewall blocking WebSocket connections',
                        'Invalid endpoint configurations'
                    ]
                });
            }, 2000);
        }
        
        function simulateHeartbeatSequence() {
            addWebSocketDebugMessage('🫀 Initializing heartbeat monitoring...', 'heartbeat', {
                endpoint: 'Primary',
                monitoringInterval: '30 seconds',
                timeoutThreshold: '60 seconds'
            });
            
            let heartbeatCount = 0;
            const heartbeatInterval = setInterval(() => {
                heartbeatCount++;
                if (heartbeatCount <= 3) {
                    addWebSocketDebugMessage(`💓 Heartbeat ping received`, 'heartbeat', {
                        type: 'ping',
                        responseTime: `${Math.floor(Math.random() * 50) + 10}ms`,
                        connectionHealth: 'Excellent'
                    });
                } else if (heartbeatCount === 4) {
                    addWebSocketDebugMessage('⚠️ Heartbeat timeout detected', 'warning', {
                        timeSinceLastHeartbeat: '65s',
                        missedCount: 1,
                        threshold: '60s',
                        connectionState: 1
                    });
                } else if (heartbeatCount === 5) {
                    addWebSocketDebugMessage('💔 Connection appears dead - multiple heartbeat timeouts', 'error', {
                        missedCount: 3,
                        lastHeartbeat: new Date(Date.now() - 180000).toISOString(),
                        recommendation: 'Consider reconnecting'
                    });
                    clearInterval(heartbeatInterval);
                }
            }, 1500);
        }
        
        function simulateBlock() {
            addWebSocketDebugMessage('New block received', 'block', {
                blockNumber: 12345678,
                transactions: 156
            });
        }
        
        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addWebSocketDebugMessage('Debug test page loaded', 'info');
            
            // 模拟一些初始消息
            setTimeout(() => {
                addWebSocketDebugMessage('Initializing blockchain manager...', 'websocket');
                addWebSocketDebugMessage('WebSocket endpoints loaded', 'success', {
                    endpoints: ['wss://mainnet.infura.io', 'wss://eth-mainnet.alchemyapi.io']
                });
            }, 1000);
        });
    </script>
</body>
</html>