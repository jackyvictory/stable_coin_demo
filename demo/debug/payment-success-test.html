<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æˆåŠŸè·³è½¬æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s;
        }
        .test-button:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        .debug-button {
            background: #007bff;
        }
        .debug-button:hover {
            background: #0056b3;
        }
        .status-display {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .countdown {
            font-size: 24px;
            color: #007bff;
            margin: 15px 0;
        }
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: left;
        }
        .payment-info h3 {
            margin-top: 0;
            color: #333;
        }
        .payment-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .payment-detail:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .detail-value {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ’° æ”¯ä»˜æˆåŠŸè·³è½¬æµ‹è¯•</h1>
        <p>æµ‹è¯• WebSocket ç‰ˆæœ¬ç›‘å¬åˆ°äº¤æ˜“åçš„è‡ªåŠ¨è·³è½¬åŠŸèƒ½</p>
        
        <div id="status-display" class="status-display status-waiting">
            ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•æ”¯ä»˜æˆåŠŸè·³è½¬
        </div>
        
        <div class="payment-info" id="payment-info" style="display: none;">
            <h3>æ¨¡æ‹Ÿæ”¯ä»˜ä¿¡æ¯</h3>
            <div class="payment-detail">
                <span class="detail-label">å•†å“:</span>
                <span class="detail-value">Food Donation (Rice)</span>
            </div>
            <div class="payment-detail">
                <span class="detail-label">é‡‘é¢:</span>
                <span class="detail-value">$10.00</span>
            </div>
            <div class="payment-detail">
                <span class="detail-label">æ”¯ä»˜æ–¹å¼:</span>
                <span class="detail-value">USDT</span>
            </div>
            <div class="payment-detail">
                <span class="detail-label">ç½‘ç»œ:</span>
                <span class="detail-value">BSC</span>
            </div>
            <div class="payment-detail">
                <span class="detail-label">PayID:</span>
                <span class="detail-value" id="payment-id">ç”Ÿæˆä¸­...</span>
            </div>
        </div>
        
        <div id="countdown" class="countdown" style="display: none;"></div>
        
        <div>
            <button class="test-button" onclick="testPaymentSuccess()">
                ğŸ‰ æµ‹è¯•æ”¯ä»˜æˆåŠŸ
            </button>
            
            <button class="test-button debug-button" onclick="testWithDebugInfo()">
                ğŸ” è¯¦ç»†è°ƒè¯•æµ‹è¯•
            </button>
            
            <button class="test-button debug-button" onclick="goToQRPage()">
                ğŸ“± å‰å¾€äºŒç»´ç é¡µé¢
            </button>
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #666;">
            <p><strong>æµ‹è¯•è¯´æ˜:</strong></p>
            <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                <li>ç‚¹å‡»"æµ‹è¯•æ”¯ä»˜æˆåŠŸ"æ¨¡æ‹Ÿå®Œæ•´çš„æ”¯ä»˜ç¡®è®¤æµç¨‹</li>
                <li>ç³»ç»Ÿä¼šåˆ›å»ºæ¨¡æ‹Ÿçš„æ”¯ä»˜æ•°æ®å¹¶è§¦å‘æˆåŠŸè·³è½¬</li>
                <li>è·³è½¬åˆ° success-ws.html é¡µé¢æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸä¿¡æ¯</li>
                <li>å¯ä»¥é€šè¿‡"è¯¦ç»†è°ƒè¯•æµ‹è¯•"æŸ¥çœ‹æ›´å¤šæŠ€æœ¯ç»†èŠ‚</li>
            </ul>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'waiting') {
            const statusDisplay = document.getElementById('status-display');
            statusDisplay.textContent = message;
            statusDisplay.className = `status-display status-${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showPaymentInfo(paymentData) {
            const paymentInfo = document.getElementById('payment-info');
            const paymentIdElement = document.getElementById('payment-id');
            
            paymentIdElement.textContent = paymentData.paymentId;
            paymentInfo.style.display = 'block';
        }

        function startCountdown(seconds, callback) {
            const countdownElement = document.getElementById('countdown');
            countdownElement.style.display = 'block';
            
            let remaining = seconds;
            
            const updateCountdown = () => {
                countdownElement.textContent = `${remaining} ç§’åè‡ªåŠ¨è·³è½¬...`;
                remaining--;
                
                if (remaining < 0) {
                    countdownElement.style.display = 'none';
                    callback();
                } else {
                    setTimeout(updateCountdown, 1000);
                }
            };
            
            updateCountdown();
        }

        function testPaymentSuccess() {
            updateStatus('å¼€å§‹æµ‹è¯•æ”¯ä»˜æˆåŠŸæµç¨‹...', 'processing');
            
            // åˆ›å»ºå®Œæ•´çš„æ”¯ä»˜æˆåŠŸæ•°æ®
            const paymentData = {
                paymentId: 'test_success_' + Date.now(),
                product: 'rice',
                price: 10.00,
                selectedPayment: { 
                    symbol: 'USDT', 
                    name: 'Tether USD' 
                },
                selectedNetwork: { 
                    symbol: 'BSC', 
                    name: 'BNB Smart Chain' 
                },
                timestamp: Date.now(),
                expiresAt: Date.now() + 30 * 60 * 1000,
                status: 'confirmed',
                confirmedAt: Date.now(),
                
                // WebSocket ç‰¹æœ‰çš„æ€§èƒ½æ•°æ®
                performanceMetrics: {
                    detectionTime: 2500, // 2.5ç§’æ£€æµ‹æ—¶é—´
                    detectionMethod: 'WebSocket',
                    matchScore: 100,
                    confirmations: 1,
                    blocksScanned: 1,
                    wsReconnects: 0
                },
                
                // éªŒè¯ç»“æœ
                verificationResult: {
                    verified: true,
                    transfer: {
                        transactionHash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                        blockNumber: 12345678,
                        formattedAmount: 10.00,
                        tokenSymbol: 'USDT',
                        from: '0x1111111111111111111111111111111111111111',
                        to: '0xe27577B0e3920cE35f100f66430de0108cb78a04'
                    },
                    confirmations: 1,
                    transactionHash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                    amount: 10.00,
                    tokenSymbol: 'USDT',
                    detectionMethod: 'WebSocket',
                    matchScore: 100,
                    validationDetails: {
                        amountMatch: true,
                        tokenMatch: true,
                        addressMatch: true,
                        timingValid: true
                    }
                },
                
                // äº¤æ˜“ä¿¡æ¯
                txHash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                blockNumber: 12345678,
                
                // é¡µé¢å¯¼èˆªçŠ¶æ€
                currentPage: 'qr-code',
                navigationHistory: ['product-selection', 'payment-selection', 'qr-code']
            };
            
            // æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯
            showPaymentInfo(paymentData);
            
            // ä¿å­˜åˆ° sessionStorage
            sessionStorage.setItem('paymentData', JSON.stringify(paymentData));
            
            updateStatus('æ”¯ä»˜æ•°æ®å·²åˆ›å»ºï¼Œæ¨¡æ‹Ÿ WebSocket æ£€æµ‹...', 'processing');
            
            // æ¨¡æ‹Ÿæ£€æµ‹è¿‡ç¨‹
            setTimeout(() => {
                updateStatus('æ£€æµ‹åˆ°æ”¯ä»˜äº¤æ˜“ï¼ŒéªŒè¯ä¸­...', 'processing');
                
                setTimeout(() => {
                    updateStatus('æ”¯ä»˜éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡è·³è½¬åˆ°æˆåŠŸé¡µé¢!', 'success');
                    
                    // å¼€å§‹å€’è®¡æ—¶è·³è½¬
                    startCountdown(3, () => {
                        console.log('è·³è½¬åˆ°æˆåŠŸé¡µé¢: success-ws.html');
                        window.location.href = '../success-ws.html';
                    });
                    
                }, 1500);
            }, 1000);
        }

        function testWithDebugInfo() {
            updateStatus('å¯åŠ¨è¯¦ç»†è°ƒè¯•æ¨¡å¼...', 'processing');
            
            console.log('=== æ”¯ä»˜æˆåŠŸè·³è½¬è°ƒè¯•ä¿¡æ¯ ===');
            
            // æ£€æŸ¥å½“å‰ç¯å¢ƒ
            console.log('1. ç¯å¢ƒæ£€æŸ¥:');
            console.log('   - sessionStorage å¯ç”¨:', typeof sessionStorage !== 'undefined');
            console.log('   - å½“å‰é¡µé¢:', window.location.href);
            console.log('   - ç”¨æˆ·ä»£ç†:', navigator.userAgent);
            
            // åˆ›å»ºè°ƒè¯•ç”¨çš„æ”¯ä»˜æ•°æ®
            const debugPaymentData = {
                paymentId: 'debug_test_' + Date.now(),
                product: 'rice',
                price: 10.00,
                selectedPayment: { symbol: 'USDT', name: 'Tether USD' },
                selectedNetwork: { symbol: 'BSC', name: 'BNB Smart Chain' },
                timestamp: Date.now(),
                status: 'confirmed',
                confirmedAt: Date.now(),
                performanceMetrics: {
                    detectionTime: 1800,
                    detectionMethod: 'WebSocket',
                    matchScore: 100
                },
                verificationResult: {
                    verified: true,
                    matchScore: 100
                }
            };
            
            console.log('2. æ”¯ä»˜æ•°æ®:');
            console.log(debugPaymentData);
            
            // ä¿å­˜æ•°æ®
            sessionStorage.setItem('paymentData', JSON.stringify(debugPaymentData));
            console.log('3. æ•°æ®å·²ä¿å­˜åˆ° sessionStorage');
            
            // éªŒè¯æ•°æ®ä¿å­˜
            const savedData = sessionStorage.getItem('paymentData');
            console.log('4. éªŒè¯ä¿å­˜çš„æ•°æ®:', savedData ? 'æˆåŠŸ' : 'å¤±è´¥');
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    console.log('5. æ•°æ®è§£æ:', parsedData.paymentId ? 'æˆåŠŸ' : 'å¤±è´¥');
                } catch (error) {
                    console.error('5. æ•°æ®è§£æå¤±è´¥:', error);
                }
            }
            
            showPaymentInfo(debugPaymentData);
            updateStatus('è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå‡†å¤‡è·³è½¬...', 'success');
            
            // å»¶è¿Ÿè·³è½¬ä»¥ä¾¿æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
            startCountdown(5, () => {
                console.log('6. æ‰§è¡Œè·³è½¬åˆ° success-ws.html');
                window.location.href = '../success-ws.html';
            });
        }

        function goToQRPage() {
            updateStatus('åˆ›å»ºæµ‹è¯•æ•°æ®å¹¶è·³è½¬åˆ°äºŒç»´ç é¡µé¢...', 'processing');
            
            // åˆ›å»ºåŸºæœ¬çš„æ”¯ä»˜æ•°æ®ç”¨äºäºŒç»´ç é¡µé¢
            const qrPaymentData = {
                paymentId: 'qr_test_' + Date.now(),
                product: 'rice',
                price: 10.00,
                selectedPayment: { symbol: 'USDT', name: 'Tether USD' },
                selectedNetwork: { symbol: 'BSC', name: 'BNB Smart Chain' },
                timestamp: Date.now(),
                expiresAt: Date.now() + 30 * 60 * 1000,
                status: 'waiting'
            };
            
            sessionStorage.setItem('paymentData', JSON.stringify(qrPaymentData));
            
            setTimeout(() => {
                window.location.href = '../qrcode-ws.html';
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç°æœ‰æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ”¯ä»˜æˆåŠŸè·³è½¬æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰çš„æ”¯ä»˜æ•°æ®
            const existingData = sessionStorage.getItem('paymentData');
            if (existingData) {
                try {
                    const paymentData = JSON.parse(existingData);
                    console.log('å‘ç°ç°æœ‰æ”¯ä»˜æ•°æ®:', paymentData.paymentId);
                    updateStatus(`å‘ç°ç°æœ‰æ”¯ä»˜æ•°æ®: ${paymentData.paymentId}`, 'processing');
                } catch (error) {
                    console.error('ç°æœ‰æ”¯ä»˜æ•°æ®è§£æå¤±è´¥:', error);
                    sessionStorage.removeItem('paymentData');
                    updateStatus('æ¸…ç†äº†æ— æ•ˆçš„æ”¯ä»˜æ•°æ®', 'waiting');
                }
            }
        });
    </script>
</body>
</html>