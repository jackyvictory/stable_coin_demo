<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Matching Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>Payment Matching Debug</h1>
        
        <div class="section">
            <h3>WebSocket Message Analysis</h3>
            <p>分析接收到的WebSocket消息，检查支付匹配逻辑</p>
            
            <button class="btn-primary" onclick="analyzeWebSocketMessage()">
                分析WebSocket消息
            </button>
            <button class="btn-success" onclick="testPaymentMatching()">
                测试支付匹配
            </button>
            <button class="btn-warning" onclick="checkPaymentData()">
                检查支付数据
            </button>
            <button class="btn-danger" onclick="clearLog()">
                清除日志
            </button>
        </div>
        
        <div class="log-area" id="debug-log">
            调试日志将显示在这里...
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '4px';
            logEntry.style.padding = '2px 4px';
            logEntry.style.borderRadius = '2px';
            
            switch (type) {
                case 'success':
                    logEntry.style.backgroundColor = '#d4edda';
                    logEntry.style.color = '#155724';
                    break;
                case 'error':
                    logEntry.style.backgroundColor = '#f8d7da';
                    logEntry.style.color = '#721c24';
                    break;
                case 'warning':
                    logEntry.style.backgroundColor = '#fff3cd';
                    logEntry.style.color = '#856404';
                    break;
                default:
                    logEntry.style.backgroundColor = '#f8f9fa';
                    logEntry.style.color = '#495057';
            }
            
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '调试日志将显示在这里...';
        }

        function analyzeWebSocketMessage() {
            log('=== WebSocket消息分析 ===', 'info');
            
            // 模拟接收到的WebSocket消息
            const wsMessage = {
                "jsonrpc": "2.0",
                "method": "eth_subscription",
                "params": {
                    "result": {
                        "address": "0x55d398326f99059ff775485246999027b3197955",
                        "blockHash": "0x6bf785654a9fc265a26e433da0038b204b5612ee096811f9bb98fde8a8cae95f",
                        "blockNumber": "0x37e1baf",
                        "data": "0x000000000000000000000000000000000000000000000000002386f26fc10000",
                        "logIndex": "0x28",
                        "removed": false,
                        "topics": [
                            "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                            "0x000000000000000000000000d87caca31c0c10110b6132bddf88221f60ff6341",
                            "0x000000000000000000000000e27577b0e3920ce35f100f66430de0108cb78a04"
                        ],
                        "transactionHash": "0x0403401f96587b71033189fcafaee475ff1e581c30b1b0d784cb76bd4e7cf8d5",
                        "transactionIndex": "0x12"
                    }
                }
            };

            const result = wsMessage.params.result;
            
            log(`合约地址: ${result.address}`, 'info');
            log(`区块号: ${parseInt(result.blockNumber, 16)}`, 'info');
            log(`交易哈希: ${result.transactionHash}`, 'info');
            
            // 解析地址
            const fromAddress = '0x' + result.topics[1].slice(26);
            const toAddress = '0x' + result.topics[2].slice(26);
            log(`发送地址: ${fromAddress}`, 'info');
            log(`接收地址: ${toAddress}`, 'info');
            
            // 解析金额
            const rawAmount = result.data;
            const amountWei = BigInt(rawAmount);
            const decimals = 18; // USDT decimals
            const amount = Number(amountWei) / Math.pow(10, decimals);
            
            log(`原始金额: ${rawAmount}`, 'info');
            log(`Wei金额: ${amountWei.toString()}`, 'info');
            log(`格式化金额: ${amount} USDT`, 'success');
            
            // 检查是否匹配预期
            const expectedReceiver = '0xe27577B0e3920cE35f100f66430de0108cb78a04';
            const expectedAmount = 10.0;
            const expectedToken = 'USDT';
            
            log('=== 匹配检查 ===', 'warning');
            log(`接收地址匹配: ${toAddress.toLowerCase() === expectedReceiver.toLowerCase() ? '✓' : '✗'}`, 
                toAddress.toLowerCase() === expectedReceiver.toLowerCase() ? 'success' : 'error');
            log(`金额匹配: ${amount === expectedAmount ? '✓' : '✗'} (期望: ${expectedAmount}, 实际: ${amount})`, 
                amount === expectedAmount ? 'success' : 'error');
            log(`代币匹配: ${expectedToken} ✓`, 'success');
        }

        function testPaymentMatching() {
            log('=== 支付匹配测试 ===', 'info');
            
            // 模拟支付监听器配置
            const monitor = {
                paymentId: 'test-payment-123',
                tokenSymbol: 'USDT',
                expectedAmount: 10.0,
                receiverAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                requiredConfirmations: 1,
                startTime: Date.now() - 60000 // 1分钟前开始
            };
            
            // 模拟转账数据
            const transfer = {
                blockNumber: 58327983,
                transactionHash: '0x0403401f96587b71033189fcafaee475ff1e581c30b1b0d784cb76bd4e7cf8d5',
                tokenContract: '0x55d398326f99059ff775485246999027b3197955',
                tokenSymbol: 'USDT',
                from: '0xd87caca31c0c10110b6132bddf88221f60ff6341',
                to: '0xe27577b0e3920ce35f100f66430de0108cb78a04',
                amount: '10000000000000000000',
                formattedAmount: 10.0,
                logIndex: 40
            };
            
            log(`监听器配置:`, 'info');
            log(`  支付ID: ${monitor.paymentId}`, 'info');
            log(`  期望代币: ${monitor.tokenSymbol}`, 'info');
            log(`  期望金额: ${monitor.expectedAmount}`, 'info');
            log(`  接收地址: ${monitor.receiverAddress}`, 'info');
            
            log(`转账数据:`, 'info');
            log(`  实际代币: ${transfer.tokenSymbol}`, 'info');
            log(`  实际金额: ${transfer.formattedAmount}`, 'info');
            log(`  接收地址: ${transfer.to}`, 'info');
            
            // 执行匹配验证
            const validation = validatePaymentMatch(transfer, monitor);
            
            log('=== 匹配结果 ===', 'warning');
            log(`匹配状态: ${validation.isMatch ? '✓ 匹配' : '✗ 不匹配'}`, 
                validation.isMatch ? 'success' : 'error');
            log(`匹配分数: ${validation.score}/100`, validation.score >= 90 ? 'success' : 'warning');
            
            if (validation.reasons.length > 0) {
                log('不匹配原因:', 'error');
                validation.reasons.forEach(reason => log(`  - ${reason}`, 'error'));
            }
            
            log('验证详情:', 'info');
            Object.entries(validation.details).forEach(([key, value]) => {
                log(`  ${key}: ${JSON.stringify(value)}`, 'info');
            });
        }

        function validatePaymentMatch(transfer, monitor) {
            const validation = {
                isMatch: false,
                score: 0,
                details: {},
                reasons: []
            };

            // 1. 代币类型验证
            const tokenMatch = monitor.tokenSymbol === transfer.tokenSymbol;
            validation.details.tokenMatch = tokenMatch;

            if (!tokenMatch) {
                validation.reasons.push(`Token mismatch: expected ${monitor.tokenSymbol}, got ${transfer.tokenSymbol}`);
                return validation;
            }
            validation.score += 30;

            // 2. 接收地址验证
            const addressMatch = monitor.receiverAddress.toLowerCase() === transfer.to.toLowerCase();
            validation.details.addressMatch = addressMatch;

            if (!addressMatch) {
                validation.reasons.push(`Address mismatch: expected ${monitor.receiverAddress}, got ${transfer.to}`);
                return validation;
            }
            validation.score += 30;

            // 3. 金额验证
            const expectedAmount = monitor.expectedAmount;
            const actualAmount = transfer.formattedAmount;
            const amountDiff = Math.abs(actualAmount - expectedAmount);
            const tolerance = Math.max(0.001, expectedAmount * 0.001);

            validation.details.expectedAmount = expectedAmount;
            validation.details.actualAmount = actualAmount;
            validation.details.amountDiff = amountDiff;
            validation.details.tolerance = tolerance;
            validation.details.amountMatch = amountDiff <= tolerance;

            if (amountDiff > tolerance) {
                validation.reasons.push(`Amount mismatch: expected ${expectedAmount}, got ${actualAmount}, diff ${amountDiff} > tolerance ${tolerance}`);
                return validation;
            }

            validation.score += 40;
            validation.isMatch = true;

            return validation;
        }

        function checkPaymentData() {
            log('=== 检查支付数据 ===', 'info');
            
            // 检查sessionStorage中的支付数据
            const paymentDataStr = sessionStorage.getItem('paymentData');
            if (paymentDataStr) {
                try {
                    const paymentData = JSON.parse(paymentDataStr);
                    log('找到sessionStorage中的支付数据:', 'success');
                    log(`  支付ID: ${paymentData.paymentId || 'N/A'}`, 'info');
                    log(`  商品: ${paymentData.product || 'N/A'}`, 'info');
                    log(`  价格: ${paymentData.price || 'N/A'}`, 'info');
                    
                    if (paymentData.selectedPayment) {
                        log(`  选择的支付方式:`, 'info');
                        log(`    代币: ${paymentData.selectedPayment.symbol || 'N/A'}`, 'info');
                        log(`    名称: ${paymentData.selectedPayment.name || 'N/A'}`, 'info');
                        log(`    合约: ${paymentData.selectedPayment.contract || 'N/A'}`, 'info');
                    }
                    
                    if (paymentData.selectedNetwork) {
                        log(`  选择的网络:`, 'info');
                        log(`    网络: ${paymentData.selectedNetwork.symbol || 'N/A'}`, 'info');
                        log(`    名称: ${paymentData.selectedNetwork.name || 'N/A'}`, 'info');
                    }
                } catch (error) {
                    log(`解析支付数据失败: ${error.message}`, 'error');
                }
            } else {
                log('未找到sessionStorage中的支付数据', 'warning');
            }
            
            // 检查全局变量
            if (typeof window.paymentData !== 'undefined') {
                log('找到全局paymentData变量:', 'success');
                log(`  类型: ${typeof window.paymentData}`, 'info');
                log(`  内容: ${JSON.stringify(window.paymentData, null, 2)}`, 'info');
            } else {
                log('未找到全局paymentData变量', 'warning');
            }
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('Payment Matching Debug 页面已加载', 'success');
            log('点击按钮开始调试...', 'info');
        });
    </script>
</body>
</html>