<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Monitoring Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .test-button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .status-display {
            margin: 10px 0;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 12px;
        }

        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>WebSocket Monitoring Test</h1>
        <p>这个页面用于测试二维码页面中的 WebSocket 监控功能是否正常工作。</p>

        <!-- 模拟二维码页面的 WebSocket 监控区域 -->
        <div class="test-section">
            <h3>🔌 WebSocket Monitoring & Control (模拟)</h3>
            
            <!-- Connection Information -->
            <div class="status-display">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: #666; font-weight: bold;">Current Endpoint:</span>
                    <span id="ws-current-endpoint" style="font-size: 11px; font-family: monospace; color: #007bff;">
                        Not connected
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: #666; font-weight: bold;">Connection Status:</span>
                    <span id="ws-connection-status" style="font-size: 12px; font-weight: bold; color: #dc3545;">
                        Disconnected
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: #666; font-weight: bold;">Blocks Checked:</span>
                    <span id="blocks-checked" style="font-size: 12px; color: #6c757d; font-weight: bold;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: #666; font-weight: bold;">Monitoring Time:</span>
                    <span id="monitoring-time" style="font-size: 12px; color: #6c757d; font-weight: bold;">00:00</span>
                </div>
            </div>

            <!-- Monitoring Target Information -->
            <div style="margin-bottom: 15px; padding: 10px; background-color: #e8f4fd; border-radius: 6px; border: 1px solid #b3d9ff;">
                <div style="font-size: 12px; color: #0056b3; font-weight: bold; margin-bottom: 8px;">🎯 Monitoring Target:</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: #666;">Target Address:</span>
                    <span id="ws-target-address" style="font-size: 10px; font-family: monospace; color: #0056b3;" title="0xe27577B0e3920cE35f100f66430de0108cb78a04">
                        0xe275...8a04
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: #666;">Expected Amount:</span>
                    <span id="ws-expected-amount" style="font-size: 11px; color: #0056b3; font-weight: bold;">
                        10.00 USDT
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: #666;">Token Contract:</span>
                    <span id="ws-token-contract" style="font-size: 10px; font-family: monospace; color: #0056b3;" title="0x55d398326f99059fF775485246999027B3197955">
                        0x55d3...7955
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 11px; color: #666;">Messages Matched:</span>
                    <span id="ws-messages-matched" style="font-size: 11px; color: #0056b3; font-weight: bold;">
                        0
                    </span>
                </div>
            </div>

            <!-- Available Endpoints -->
            <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                <div style="font-size: 12px; color: #856404; font-weight: bold; margin-bottom: 8px;">📡 Available Endpoints:</div>
                <div id="ws-backup-endpoints" style="font-size: 11px; font-family: monospace; color: #856404; line-height: 1.6; white-space: pre-line;">
                    Loading endpoints...
                </div>
            </div>

            <!-- Control Buttons -->
            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                <button id="ws-main-control-button" onclick="handleWebSocketControl()"
                    style="padding: 10px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                    🔌 Connect
                </button>
                <button id="monitoring-control-button" onclick="toggleMonitoring()"
                    style="padding: 10px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                    🛑 Stop Monitoring
                </button>
                <button onclick="toggleWebSocketDebugInfo()"
                    style="padding: 10px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    📊 Debug Info
                </button>
            </div>

            <!-- WebSocket Debug Messages Panel -->
            <div id="ws-debug-messages" style="display: none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h5 style="margin: 0; color: #495057; font-size: 13px;">📡 WebSocket Messages</h5>
                    <button onclick="clearWebSocketDebugMessages()" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                        Clear
                    </button>
                </div>
                <div id="ws-debug-content" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; line-height: 1.4; background-color: #ffffff; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    <div style="color: #6c757d; font-style: italic;">WebSocket messages will appear here...</div>
                </div>
            </div>
        </div>

        <!-- 测试控制区域 -->
        <div class="test-section">
            <h3>🧪 Test Controls</h3>
            <button class="test-button btn-primary" onclick="testWebSocketStatus()">
                Test WebSocket Status Update
            </button>
            <button class="test-button btn-success" onclick="simulateBlockProgress()">
                Simulate Block Progress
            </button>
            <button class="test-button btn-danger" onclick="simulatePaymentFound()">
                Simulate Payment Found
            </button>
            <button class="test-button btn-primary" onclick="testAddressFormatting()">
                📍 Test Address Formatting
            </button>
            <button class="test-button btn-success" onclick="testMonitoringToggle()">
                🔄 Test Monitoring Toggle
            </button>
            
            <div class="log-area" id="test-log">
                Test log will appear here...
            </div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="../config.js"></script>
    <script src="../lib/web3.min.js"></script>
    <script src="../js/blockchain-ws.js"></script>
    <script src="../js/payment-handler-ws.js"></script>

    <script>
        // 模拟支付数据
        let paymentData = {
            paymentId: 'test-' + Date.now(),
            product: 'rice',
            price: 10.00,
            selectedPayment: {
                symbol: 'USDT',
                name: 'Tether USD',
                contract: '0x55d398326f99059fF775485246999027B3197955'
            },
            selectedNetwork: {
                symbol: 'BSC',
                name: 'BNB Smart Chain'
            },
            timestamp: Date.now(),
            expiresAt: Date.now() + 30 * 60 * 1000
        };

        // 监控状态变量
        let isMonitoringEnabled = true;

        // 从 qrcode-ws.js 复制的关键函数
        function updateWebSocketStatusInfo() {
            updateWebSocketConnectionStatus();
            updateWebSocketEndpointsInfo();
        }

        function updateWebSocketConnectionStatus() {
            const endpointElement = document.getElementById('ws-current-endpoint');
            const statusElement = document.getElementById('ws-connection-status');
            
            if (!endpointElement || !statusElement) return;
            
            if (window.blockchainManager && window.blockchainManager.wsMonitor) {
                const wsMonitor = window.blockchainManager.wsMonitor;
                
                if (wsMonitor.isConnected && wsMonitor.wsEndpoints && wsMonitor.currentEndpointIndex >= 0) {
                    const currentEndpoint = wsMonitor.wsEndpoints[wsMonitor.currentEndpointIndex];
                    endpointElement.textContent = currentEndpoint.name || currentEndpoint.url;
                    endpointElement.style.color = '#007bff';
                } else {
                    endpointElement.textContent = 'Not connected';
                    endpointElement.style.color = '#6c757d';
                }
                
                if (wsMonitor.isConnected) {
                    statusElement.textContent = 'Connected';
                    statusElement.style.color = '#28a745';
                } else if (wsMonitor.connectionState === 'connecting') {
                    statusElement.textContent = 'Connecting...';
                    statusElement.style.color = '#ffc107';
                } else {
                    statusElement.textContent = 'Disconnected';
                    statusElement.style.color = '#dc3545';
                }
            } else {
                endpointElement.textContent = 'Manager not ready';
                endpointElement.style.color = '#6c757d';
                statusElement.textContent = 'Not initialized';
                statusElement.style.color = '#6c757d';
            }
        }

        function updateWebSocketEndpointsInfo() {
            const endpointsElement = document.getElementById('ws-backup-endpoints');
            
            if (!endpointsElement) return;
            
            if (window.blockchainManager && window.blockchainManager.wsMonitor && window.blockchainManager.wsMonitor.wsEndpoints) {
                const endpoints = window.blockchainManager.wsMonitor.wsEndpoints;
                const currentIndex = window.blockchainManager.wsMonitor.currentEndpointIndex;
                
                let endpointsText = '';
                endpoints.forEach((endpoint, index) => {
                    const status = index === currentIndex ? '🟢 Active' : '⚪ Standby';
                    endpointsText += `${status} ${endpoint.name || `EP${index + 1}`}\n`;
                });
                
                endpointsElement.textContent = endpointsText.trim();
            } else {
                endpointsElement.textContent = 'Endpoints not loaded';
            }
        }

        function handleWebSocketControl() {
            const button = document.getElementById('ws-main-control-button');
            if (!button) return;
            
            if (window.blockchainManager && window.blockchainManager.wsMonitor) {
                const wsMonitor = window.blockchainManager.wsMonitor;
                
                if (wsMonitor.isConnected) {
                    wsMonitor.disconnect();
                    button.textContent = '🔌 Connect';
                    button.style.background = '#28a745';
                    addWebSocketDebugMessage('WebSocket disconnected manually', 'warning');
                } else {
                    // 检查监控是否被禁用
                    if (!isMonitoringEnabled) {
                        addWebSocketDebugMessage('❌ Cannot reconnect - monitoring is disabled', 'warning');
                        return;
                    }
                    
                    button.textContent = '⏳ Connecting...';
                    button.style.background = '#6c757d';
                    addWebSocketDebugMessage('Attempting WebSocket connection...', 'info');
                    
                    wsMonitor.connect().then(success => {
                        if (success) {
                            button.textContent = '🔌 Disconnect';
                            button.style.background = '#dc3545';
                            addWebSocketDebugMessage('WebSocket connected successfully', 'success');
                        } else {
                            button.textContent = '🔌 Connect';
                            button.style.background = '#28a745';
                            addWebSocketDebugMessage('WebSocket connection failed', 'error');
                        }
                    });
                }
            } else {
                addWebSocketDebugMessage('Blockchain manager not available', 'error');
            }
        }

        // 监控控制函数
        function toggleMonitoring() {
            const button = document.getElementById('monitoring-control-button');
            if (!button) return;
            
            if (isMonitoringEnabled) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        }

        function stopMonitoring() {
            addWebSocketDebugMessage('🛑 Stopping payment monitoring...', 'warning');
            isMonitoringEnabled = false;
            
            // 断开WebSocket连接并禁用自动重连
            if (window.blockchainManager && window.blockchainManager.wsMonitor) {
                const wsMonitor = window.blockchainManager.wsMonitor;
                if (wsMonitor.isConnected) {
                    addWebSocketDebugMessage('Disconnecting WebSocket (monitoring stopped)', 'warning');
                    wsMonitor.autoReconnect = false;
                    wsMonitor.disconnect();
                }
            }
            
            updateMonitoringControlButton();
            addWebSocketDebugMessage('✅ Payment monitoring stopped successfully', 'success');
        }

        function startMonitoring() {
            addWebSocketDebugMessage('🚀 Starting payment monitoring...', 'info');
            isMonitoringEnabled = true;
            
            // 启用自动重连
            if (window.blockchainManager && window.blockchainManager.wsMonitor) {
                window.blockchainManager.wsMonitor.autoReconnect = true;
            }
            
            updateMonitoringControlButton();
            addWebSocketDebugMessage('✅ Payment monitoring started successfully', 'success');
        }

        function updateMonitoringControlButton() {
            const button = document.getElementById('monitoring-control-button');
            if (!button) return;
            
            if (isMonitoringEnabled) {
                button.textContent = '🛑 Stop Monitoring';
                button.style.background = '#dc3545';
                button.title = 'Stop payment monitoring and disconnect WebSocket';
            } else {
                button.textContent = '🚀 Start Monitoring';
                button.style.background = '#28a745';
                button.title = 'Start payment monitoring and connect WebSocket';
            }
        }

        function toggleWebSocketDebugInfo() {
            const debugPanel = document.getElementById('ws-debug-messages');
            if (!debugPanel) return;
            
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        }

        function clearWebSocketDebugMessages() {
            const debugContent = document.getElementById('ws-debug-content');
            if (debugContent) {
                debugContent.innerHTML = '<div style="color: #6c757d; font-style: italic;">WebSocket messages will appear here...</div>';
            }
        }

        function addWebSocketDebugMessage(message, type = 'info') {
            const debugContent = document.getElementById('ws-debug-content');
            if (!debugContent) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '4px';
            messageElement.style.padding = '2px 4px';
            messageElement.style.borderRadius = '2px';
            
            switch (type) {
                case 'success':
                    messageElement.style.backgroundColor = '#d4edda';
                    messageElement.style.color = '#155724';
                    break;
                case 'error':
                    messageElement.style.backgroundColor = '#f8d7da';
                    messageElement.style.color = '#721c24';
                    break;
                case 'warning':
                    messageElement.style.backgroundColor = '#fff3cd';
                    messageElement.style.color = '#856404';
                    break;
                default:
                    messageElement.style.backgroundColor = '#f8f9fa';
                    messageElement.style.color = '#495057';
            }
            
            messageElement.textContent = `[${timestamp}] ${message}`;
            
            if (debugContent.children.length === 1 && debugContent.children[0].style.fontStyle === 'italic') {
                debugContent.innerHTML = '';
            }
            
            debugContent.appendChild(messageElement);
            debugContent.scrollTop = debugContent.scrollHeight;
            
            while (debugContent.children.length > 50) {
                debugContent.removeChild(debugContent.firstChild);
            }
        }

        // 测试函数
        function testWebSocketStatus() {
            logTest('Testing WebSocket status update...');
            updateWebSocketStatusInfo();
            addWebSocketDebugMessage('Status update test completed', 'info');
            logTest('WebSocket status updated');
        }

        function simulateBlockProgress() {
            logTest('Simulating block progress...');
            const blockNumber = Math.floor(Math.random() * 1000000) + 20000000;
            
            // 更新区块计数
            const blocksCheckedElement = document.getElementById('blocks-checked');
            if (blocksCheckedElement) {
                const currentCount = parseInt(blocksCheckedElement.textContent) || 0;
                blocksCheckedElement.textContent = currentCount + 1;
            }
            
            addWebSocketDebugMessage(`New block: ${blockNumber}`, 'info');
            logTest(`Simulated block ${blockNumber} processing`);
        }

        function simulatePaymentFound() {
            logTest('Simulating payment found...');
            addWebSocketDebugMessage('🎉 Payment confirmed!', 'success');
            
            // 更新消息匹配计数
            const messagesMatchedElement = document.getElementById('ws-messages-matched');
            if (messagesMatchedElement) {
                const currentCount = parseInt(messagesMatchedElement.textContent) || 0;
                messagesMatchedElement.textContent = currentCount + 1;
            }
            
            logTest('Payment confirmation simulated');
        }

        function testAddressFormatting() {
            logTest('Testing address formatting...');
            
            const addresses = [
                '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                '0x55d398326f99059fF775485246999027B3197955',
                '0x1234567890abcdef1234567890abcdef12345678'
            ];
            
            const formatAddress = (address) => {
                if (!address || address.length <= 12) return address;
                return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
            };
            
            addresses.forEach((address, index) => {
                const formatted = formatAddress(address);
                addWebSocketDebugMessage(`Address ${index + 1}: ${formatted}`, 'info');
                logTest(`Address ${index + 1}: ${address} -> ${formatted}`);
            });
        }

        function testMonitoringToggle() {
            logTest('Testing monitoring toggle...');
            
            // 模拟停止监控
            setTimeout(() => {
                addWebSocketDebugMessage('🛑 Stopping payment monitoring...', 'warning');
                addWebSocketDebugMessage('Payment listener stopped', 'warning');
                addWebSocketDebugMessage('Disconnecting WebSocket (monitoring stopped)', 'warning');
                addWebSocketDebugMessage('✅ Payment monitoring stopped successfully', 'success');
                logTest('Monitoring stop sequence completed');
            }, 1000);
            
            // 模拟重新开始监控
            setTimeout(() => {
                addWebSocketDebugMessage('🚀 Starting payment monitoring...', 'info');
                addWebSocketDebugMessage('Reinitializing payment listener...', 'info');
                addWebSocketDebugMessage('✅ Payment monitoring started successfully', 'success');
                logTest('Monitoring start sequence completed');
            }, 3000);
        }

        function logTest(message) {
            const logArea = document.getElementById('test-log');
            if (logArea) {
                const timestamp = new Date().toLocaleTimeString();
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            logTest('WebSocket Monitoring Test initialized');
            
            // 初始化按钮状态
            updateMonitoringControlButton();
            
            // 定期更新状态
            setInterval(() => {
                updateWebSocketStatusInfo();
                updateMonitoringControlButton();
            }, 2000);
            
            // 等待区块链管理器
            const checkBlockchain = () => {
                if (typeof window.blockchainManager !== 'undefined') {
                    logTest('Blockchain Manager detected');
                    updateWebSocketStatusInfo();
                } else {
                    logTest('Waiting for Blockchain Manager...');
                    setTimeout(checkBlockchain, 1000);
                }
            };
            
            checkBlockchain();
        });

        // 监听区块链就绪事件
        window.addEventListener('blockchainReady', (event) => {
            logTest('Received blockchainReady event');
            updateWebSocketStatusInfo();
        });
    </script>
</body>

</html>