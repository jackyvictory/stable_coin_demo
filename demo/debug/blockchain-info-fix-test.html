<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Info Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #007bff;
        }
        
        .test-button:hover {
            background-color: #0056b3;
        }
        
        .test-button.success {
            background-color: #28a745;
        }
        
        .test-button.warning {
            background-color: #ffc107;
            color: #000;
        }
        
        .test-button.danger {
            background-color: #dc3545;
        }
        
        .blockchain-info {
            width: 100%;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .blockchain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        
        .blockchain-title {
            margin: 0;
            color: #495057;
            font-size: 16px;
            font-weight: bold;
        }
        
        .blockchain-details {
            padding: 0;
        }
        
        .blockchain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .blockchain-item:last-child {
            border-bottom: none;
        }
        
        .blockchain-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
            min-width: 140px;
        }
        
        .blockchain-value {
            font-size: 14px;
            color: #495057;
            font-family: 'Courier New', monospace;
            text-align: right;
        }
        
        .blockchain-value.address {
            color: #28a745;
            font-weight: 500;
        }
        
        .blockchain-value.hash {
            color: #007bff;
            font-weight: 500;
        }
        
        .blockchain-value.network {
            color: #6f42c1;
            font-weight: bold;
            font-family: inherit;
        }
        
        .blockchain-value.amount {
            color: #dc3545;
            font-weight: bold;
        }
        
        .data-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .success-indicator {
            color: #28a745;
            font-weight: bold;
        }
        
        .error-indicator {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning-indicator {
            color: #ffc107;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ Blockchain Info ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„ Blockchain Info æ•°æ®æ˜¾ç¤ºåŠŸèƒ½</p>
        
        <!-- æµ‹è¯•æŒ‰é’® -->
        <div>
            <button class="test-button success" onclick="testFixedData()">æµ‹è¯•ä¿®å¤åçš„æ•°æ®ç»“æ„</button>
            <button class="test-button" onclick="testOldData()">æµ‹è¯•æ—§æ•°æ®ç»“æ„</button>
            <button class="test-button warning" onclick="testMixedData()">æµ‹è¯•æ··åˆæ•°æ®</button>
            <button class="test-button danger" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>
        
        <!-- æ•°æ®ç»“æ„å¯¹æ¯” -->
        <div style="display: flex; gap: 20px; margin-top: 20px;">
            <div style="flex: 1;">
                <h3>ğŸ”§ ä¿®å¤åçš„æ•°æ®ç»“æ„</h3>
                <div class="data-preview" id="fixed-data-preview">
ç‚¹å‡»"æµ‹è¯•ä¿®å¤åçš„æ•°æ®ç»“æ„"æŸ¥çœ‹...
                </div>
            </div>
            <div style="flex: 1;">
                <h3>âŒ æ—§æ•°æ®ç»“æ„</h3>
                <div class="data-preview" id="old-data-preview">
ç‚¹å‡»"æµ‹è¯•æ—§æ•°æ®ç»“æ„"æŸ¥çœ‹...
                </div>
            </div>
        </div>
        
        <!-- Blockchain Info æ˜¾ç¤º -->
        <div class="blockchain-info">
            <div class="blockchain-header">
                <h3 class="blockchain-title">ğŸ”— Blockchain Info</h3>
            </div>
            <div class="blockchain-details">
                <div class="blockchain-item">
                    <span class="blockchain-label">Blockchain Name:</span>
                    <span class="blockchain-value network" id="blockchain-name">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">Transaction Hash:</span>
                    <span class="blockchain-value hash" id="blockchain-tx-hash">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">Block Number:</span>
                    <span class="blockchain-value" id="blockchain-block-number">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">From Address:</span>
                    <span class="blockchain-value address" id="blockchain-from-addr">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">To Address:</span>
                    <span class="blockchain-value address" id="blockchain-to-addr">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">Contract Address:</span>
                    <span class="blockchain-value address" id="blockchain-contract-addr">N/A</span>
                </div>
                <div class="blockchain-item">
                    <span class="blockchain-label">Amount & Currency:</span>
                    <span class="blockchain-value amount" id="blockchain-amount">N/A</span>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœ -->
        <div style="margin-top: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px;">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="test-results">
                ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹ç»“æœ...
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ä¿®å¤åçš„æ•°æ®ç»“æ„
        function testFixedData() {
            console.log('ğŸ”§ Testing fixed data structure...');
            
            // æ¨¡æ‹Ÿä¿®å¤åçš„æ”¯ä»˜æ•°æ®ç»“æ„
            const fixedPaymentData = {
                product: 'rice',
                price: 10.00,
                paymentId: 'PAY-FIXED-001',
                selectedPayment: {
                    symbol: 'USDT',
                    name: 'Tether USD',
                    contractAddress: '0x55d398326f99059fF775485246999027B3197955'
                },
                selectedNetwork: {
                    symbol: 'BSC',
                    name: 'BNB Smart Chain',
                    chainId: 56
                },
                walletAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                timestamp: Date.now(),
                confirmedAt: Date.now(),
                status: 'confirmed',
                // ä¿®å¤åçš„ confirmationData ç»“æ„
                confirmationData: {
                    transactionHash: '0x1a2b3c4d5e6f7890abcdef1234567890abcdef1234567890abcdef1234567890',
                    blockNumber: 12345678,
                    fromAddress: '0xabcdef1234567890abcdef1234567890abcdef12',
                    toAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                    contractAddress: '0x55d398326f99059fF775485246999027B3197955',
                    amount: 10.00,
                    tokenSymbol: 'USDT',
                    blockTimestamp: Date.now(),
                    networkName: 'BNB Smart Chain (BSC)'
                }
            };
            
            // æ˜¾ç¤ºæ•°æ®ç»“æ„
            document.getElementById('fixed-data-preview').textContent = JSON.stringify(fixedPaymentData, null, 2);
            
            // ä¿å­˜åˆ° sessionStorage å¹¶æµ‹è¯•
            sessionStorage.setItem('paymentData', JSON.stringify(fixedPaymentData));
            testDataExtraction(fixedPaymentData, 'fixed');
        }
        
        // æµ‹è¯•æ—§æ•°æ®ç»“æ„
        function testOldData() {
            console.log('âŒ Testing old data structure...');
            
            // æ¨¡æ‹Ÿæ—§çš„æ”¯ä»˜æ•°æ®ç»“æ„ï¼ˆæ²¡æœ‰ confirmationDataï¼‰
            const oldPaymentData = {
                product: 'rice',
                price: 10.00,
                paymentId: 'PAY-OLD-001',
                selectedPayment: {
                    symbol: 'USDT',
                    name: 'Tether USD',
                    contractAddress: '0x55d398326f99059fF775485246999027B3197955'
                },
                selectedNetwork: {
                    symbol: 'BSC',
                    name: 'BNB Smart Chain',
                    chainId: 56
                },
                walletAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                timestamp: Date.now(),
                confirmedAt: Date.now(),
                status: 'confirmed',
                // æ—§çš„æ•°æ®ç»“æ„ï¼ˆç›´æ¥åœ¨æ ¹çº§åˆ«ï¼‰
                txHash: '0x1a2b3c4d5e6f7890abcdef1234567890abcdef1234567890abcdef1234567890',
                blockNumber: 12345678
            };
            
            // æ˜¾ç¤ºæ•°æ®ç»“æ„
            document.getElementById('old-data-preview').textContent = JSON.stringify(oldPaymentData, null, 2);
            
            // ä¿å­˜åˆ° sessionStorage å¹¶æµ‹è¯•
            sessionStorage.setItem('paymentData', JSON.stringify(oldPaymentData));
            testDataExtraction(oldPaymentData, 'old');
        }
        
        // æµ‹è¯•æ··åˆæ•°æ®
        function testMixedData() {
            console.log('âš ï¸ Testing mixed data structure...');
            
            // æ¨¡æ‹Ÿæ··åˆæ•°æ®ç»“æ„
            const mixedPaymentData = {
                product: 'rice',
                price: 15.50,
                paymentId: 'PAY-MIXED-001',
                selectedPayment: {
                    symbol: 'USDC',
                    name: 'USD Coin',
                    contractAddress: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d'
                },
                selectedNetwork: {
                    symbol: 'BSC',
                    name: 'BNB Smart Chain',
                    chainId: 56
                },
                walletAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04',
                timestamp: Date.now(),
                confirmedAt: Date.now(),
                status: 'confirmed',
                // éƒ¨åˆ† confirmationData
                confirmationData: {
                    transactionHash: '0x9f8e7d6c5b4a3928f7e6d5c4b3a29180f7e6d5c4',
                    blockNumber: 12345679,
                    amount: 15.50,
                    tokenSymbol: 'USDC'
                    // ç¼ºå°‘åœ°å€ä¿¡æ¯
                }
            };
            
            // ä¿å­˜åˆ° sessionStorage å¹¶æµ‹è¯•
            sessionStorage.setItem('paymentData', JSON.stringify(mixedPaymentData));
            testDataExtraction(mixedPaymentData, 'mixed');
        }
        
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAll() {
            sessionStorage.removeItem('paymentData');
            
            // é‡ç½®æ˜¾ç¤º
            const elements = [
                'blockchain-name', 'blockchain-tx-hash', 'blockchain-block-number',
                'blockchain-from-addr', 'blockchain-to-addr', 'blockchain-contract-addr', 'blockchain-amount'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'N/A';
                    element.className = 'blockchain-value';
                }
            });
            
            document.getElementById('test-results').innerHTML = '<span class="warning-indicator">æ‰€æœ‰æ•°æ®å·²æ¸…é™¤</span>';
            document.getElementById('fixed-data-preview').textContent = 'æ•°æ®å·²æ¸…é™¤';
            document.getElementById('old-data-preview').textContent = 'æ•°æ®å·²æ¸…é™¤';
        }
        
        // æµ‹è¯•æ•°æ®æå–
        function testDataExtraction(paymentData, testType) {
            console.log(`ğŸ§ª Testing data extraction for ${testType} structure...`);
            
            try {
                // æå–åŒºå—é“¾æ•°æ®
                const blockchainData = extractBlockchainData(paymentData);
                console.log('Extracted blockchain data:', blockchainData);
                
                // æ›´æ–°æ˜¾ç¤º
                updateBlockchainDisplay(blockchainData, paymentData);
                
                // è®¡ç®—æˆåŠŸç‡
                const fields = ['transactionHash', 'blockNumber', 'fromAddress', 'toAddress', 'contractAddress', 'amountAndCurrency'];
                const successCount = fields.filter(field => blockchainData[field] && blockchainData[field] !== 'N/A').length;
                const successRate = (successCount / fields.length * 100).toFixed(1);
                
                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                const resultHtml = `
                    <div style="margin-bottom: 10px;">
                        <strong>æµ‹è¯•ç±»å‹:</strong> ${testType.toUpperCase()} æ•°æ®ç»“æ„
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æ•°æ®æå–æˆåŠŸç‡:</strong> 
                        <span class="${successRate >= 80 ? 'success' : successRate >= 50 ? 'warning' : 'error'}-indicator">
                            ${successRate}% (${successCount}/${fields.length} å­—æ®µ)
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æå–çš„å­—æ®µ:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${fields.map(field => {
                                const value = blockchainData[field];
                                const hasValue = value && value !== 'N/A';
                                return `<li><span class="${hasValue ? 'success' : 'error'}-indicator">${field}: ${hasValue ? 'âœ“' : 'âœ—'}</span></li>`;
                            }).join('')}
                        </ul>
                    </div>
                    <div>
                        <strong>å»ºè®®:</strong> 
                        ${successRate >= 80 ? 
                            '<span class="success-indicator">æ•°æ®ç»“æ„è‰¯å¥½ï¼Œæ‰€æœ‰å­—æ®µéƒ½èƒ½æ­£ç¡®æå–</span>' :
                            successRate >= 50 ?
                            '<span class="warning-indicator">éƒ¨åˆ†å­—æ®µç¼ºå¤±ï¼Œå»ºè®®æ£€æŸ¥æ•°æ®æº</span>' :
                            '<span class="error-indicator">å¤§éƒ¨åˆ†å­—æ®µç¼ºå¤±ï¼Œéœ€è¦ä¿®å¤æ•°æ®ç»“æ„</span>'
                        }
                    </div>
                `;
                
                document.getElementById('test-results').innerHTML = resultHtml;
                
            } catch (error) {
                console.error('Error during data extraction:', error);
                document.getElementById('test-results').innerHTML = `
                    <span class="error-indicator">æ•°æ®æå–å¤±è´¥: ${error.message}</span>
                `;
            }
        }
        
        // æ›´æ–°åŒºå—é“¾ä¿¡æ¯æ˜¾ç¤º
        function updateBlockchainDisplay(blockchainData, paymentData) {
            // æ›´æ–°åŒºå—é“¾åç§°
            const networkName = getBlockchainName(paymentData);
            updateElement('blockchain-name', networkName, 'network');
            
            // æ›´æ–°å„ä¸ªå­—æ®µ
            updateElement('blockchain-tx-hash', blockchainData.transactionHash || 'N/A', 'hash');
            updateElement('blockchain-block-number', blockchainData.blockNumber || 'N/A');
            updateElement('blockchain-from-addr', blockchainData.fromAddress || 'N/A', 'address');
            updateElement('blockchain-to-addr', blockchainData.toAddress || 'N/A', 'address');
            updateElement('blockchain-contract-addr', blockchainData.contractAddress || 'N/A', 'address');
            updateElement('blockchain-amount', blockchainData.amountAndCurrency || 'N/A', 'amount');
        }
        
        // æ›´æ–°å•ä¸ªå…ƒç´ 
        function updateElement(id, value, className = '') {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                element.className = `blockchain-value ${className}`.trim();
            }
        }
        
        // ä»æ”¯ä»˜æ•°æ®ä¸­æå–åŒºå—é“¾ä¿¡æ¯ (å¤åˆ¶è‡ª success-ws.js)
        function extractBlockchainData(paymentData) {
            const blockchainData = {
                transactionHash: null,
                fullTransactionHash: null,
                blockNumber: null,
                fromAddress: null,
                fullFromAddress: null,
                toAddress: null,
                fullToAddress: null,
                contractAddress: null,
                fullContractAddress: null,
                amountAndCurrency: null
            };
            
            // å°è¯•ä»ä¸åŒçš„æ•°æ®æºæå–ä¿¡æ¯
            let sourceData = null;
            
            // ä¼˜å…ˆä½¿ç”¨ confirmationDataï¼ˆWebSocket ç›‘å¬åˆ°çš„æ•°æ®ï¼‰
            if (paymentData.confirmationData) {
                sourceData = paymentData.confirmationData;
                console.log('âœ… Using confirmationData as source:', sourceData);
            }
            // å…¶æ¬¡ä½¿ç”¨ç›´æ¥çš„æ”¯ä»˜æ•°æ®å­—æ®µ
            else if (paymentData.transactionHash || paymentData.blockNumber) {
                sourceData = paymentData;
                console.log('âœ… Using paymentData as source (has tx/block):', sourceData);
            }
            // æœ€åå°è¯•ä» blockchainInfo å­—æ®µ
            else if (paymentData.blockchainInfo) {
                sourceData = paymentData.blockchainInfo;
                console.log('âœ… Using blockchainInfo as source:', sourceData);
            } else {
                console.warn('âš ï¸ No suitable blockchain data source found');
            }
            
            if (sourceData) {
                // äº¤æ˜“å“ˆå¸Œ
                if (sourceData.transactionHash) {
                    blockchainData.fullTransactionHash = sourceData.transactionHash;
                    blockchainData.transactionHash = formatTransactionHash(sourceData.transactionHash);
                }
                
                // åŒºå—å·
                if (sourceData.blockNumber) {
                    blockchainData.blockNumber = `#${sourceData.blockNumber}`;
                }
                
                // å‘é€åœ°å€
                if (sourceData.fromAddress) {
                    blockchainData.fullFromAddress = sourceData.fromAddress;
                    blockchainData.fromAddress = formatAddress(sourceData.fromAddress);
                } else if (sourceData.from) {
                    blockchainData.fullFromAddress = sourceData.from;
                    blockchainData.fromAddress = formatAddress(sourceData.from);
                }
                
                // æ¥æ”¶åœ°å€
                if (sourceData.toAddress) {
                    blockchainData.fullToAddress = sourceData.toAddress;
                    blockchainData.toAddress = formatAddress(sourceData.toAddress);
                } else if (sourceData.to) {
                    blockchainData.fullToAddress = sourceData.to;
                    blockchainData.toAddress = formatAddress(sourceData.to);
                }
                
                // åˆçº¦åœ°å€
                if (sourceData.contractAddress) {
                    blockchainData.fullContractAddress = sourceData.contractAddress;
                    blockchainData.contractAddress = formatAddress(sourceData.contractAddress);
                } else if (sourceData.tokenContract) {
                    blockchainData.fullContractAddress = sourceData.tokenContract;
                    blockchainData.contractAddress = formatAddress(sourceData.tokenContract);
                }
                
                // é‡‘é¢å’Œè´§å¸
                if (sourceData.amount && sourceData.tokenSymbol) {
                    blockchainData.amountAndCurrency = `${sourceData.amount} ${sourceData.tokenSymbol}`;
                }
            }
            
            // å¦‚æœæ²¡æœ‰ä» WebSocket æ•°æ®ä¸­è·å–åˆ°ä¿¡æ¯ï¼Œä½¿ç”¨æ”¯ä»˜æ•°æ®çš„åŸºæœ¬ä¿¡æ¯
            if (!blockchainData.toAddress && paymentData.walletAddress) {
                blockchainData.fullToAddress = paymentData.walletAddress;
                blockchainData.toAddress = formatAddress(paymentData.walletAddress);
            }
            
            if (!blockchainData.amountAndCurrency && paymentData.price && paymentData.selectedPayment?.symbol) {
                blockchainData.amountAndCurrency = `${paymentData.price} ${paymentData.selectedPayment.symbol}`;
            }
            
            if (!blockchainData.contractAddress && paymentData.selectedPayment?.contractAddress) {
                blockchainData.fullContractAddress = paymentData.selectedPayment.contractAddress;
                blockchainData.contractAddress = formatAddress(paymentData.selectedPayment.contractAddress);
            }
            
            return blockchainData;
        }
        
        // è·å–åŒºå—é“¾åç§°
        function getBlockchainName(paymentData) {
            if (paymentData.selectedNetwork?.name) {
                return paymentData.selectedNetwork.name;
            }
            
            if (paymentData.confirmationData?.networkName) {
                return paymentData.confirmationData.networkName;
            }
            
            if (paymentData.selectedNetwork?.chainId) {
                const chainId = paymentData.selectedNetwork.chainId;
                switch (chainId) {
                    case 56: return 'BNB Smart Chain (BSC)';
                    case 1: return 'Ethereum Mainnet';
                    case 137: return 'Polygon';
                    case 43114: return 'Avalanche';
                    case 250: return 'Fantom';
                    default: return `Chain ID ${chainId}`;
                }
            }
            
            return 'BNB Smart Chain (BSC)';
        }
        
        // æ ¼å¼åŒ–äº¤æ˜“å“ˆå¸Œ
        function formatTransactionHash(hash) {
            if (!hash || hash === 'N/A') return 'N/A';
            if (hash.length <= 20) return hash;
            return `${hash.substring(0, 10)}...${hash.substring(hash.length - 6)}`;
        }
        
        // æ ¼å¼åŒ–åœ°å€
        function formatAddress(address) {
            if (!address || address === 'N/A') return 'N/A';
            if (address.length <= 20) return address;
            return `${address.substring(0, 8)}...${address.substring(address.length - 6)}`;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ”§ Blockchain Info Fix Test loaded');
            console.log('ğŸ’¡ Click test buttons to verify the fix');
        });
    </script>
</body>
</html>