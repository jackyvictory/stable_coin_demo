<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; height: 400px; overflow-y: auto; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>Simple WebSocket Test</h1>
    
    <div>
        <button class="btn-primary" onclick="testDirectWebSocket()">Test Direct WebSocket</button>
        <button class="btn-success" onclick="testBlockchainManager()">Test Blockchain Manager</button>
        <button class="btn-danger" onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="log" id="log"></div>

    <script src="../config.js"></script>
    <script src="../lib/web3.min.js"></script>
    <script src="../js/blockchain-ws.js"></script>

    <script>
        let logElement;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.textContent += logEntry;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(message);
        }

        function clearLog() {
            if (logElement) {
                logElement.textContent = '';
            }
        }

        async function testDirectWebSocket() {
            log('ðŸ”Œ Testing direct WebSocket connection...');
            
            const endpoints = [
                'wss://bsc-ws-node.nariox.org/',
                'wss://bsc.publicnode.com/'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`Trying ${endpoint}...`);
                    
                    const ws = new WebSocket(endpoint);
                    
                    const result = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            ws.close();
                            reject(new Error('Connection timeout'));
                        }, 5000);
                        
                        ws.onopen = () => {
                            clearTimeout(timeout);
                            log(`âœ… Connected to ${endpoint}`);
                            
                            // Send a test message
                            const testMessage = {
                                jsonrpc: '2.0',
                                method: 'net_version',
                                params: [],
                                id: 1
                            };
                            
                            ws.send(JSON.stringify(testMessage));
                        };
                        
                        ws.onmessage = (event) => {
                            log(`ðŸ“¨ Received: ${event.data}`);
                            ws.close();
                            resolve(true);
                        };
                        
                        ws.onerror = (error) => {
                            clearTimeout(timeout);
                            log(`âŒ Error: ${error.message || 'WebSocket error'}`);
                            reject(error);
                        };
                        
                        ws.onclose = (event) => {
                            clearTimeout(timeout);
                            log(`ðŸ”Œ Connection closed: ${event.code} - ${event.reason}`);
                        };
                    });
                    
                    if (result) {
                        log(`âœ… ${endpoint} works!`);
                        return;
                    }
                } catch (error) {
                    log(`âŒ ${endpoint} failed: ${error.message}`);
                }
            }
            
            log('âŒ All endpoints failed');
        }

        async function testBlockchainManager() {
            log('ðŸ” Testing blockchain manager...');
            
            if (typeof window.blockchainManager === 'undefined') {
                log('âŒ window.blockchainManager not found');
                return;
            }
            
            log('âœ… window.blockchainManager found');
            
            if (!window.blockchainManager.wsMonitor) {
                log('âŒ wsMonitor not found');
                return;
            }
            
            log('âœ… wsMonitor found');
            log(`   isConnected: ${window.blockchainManager.wsMonitor.isConnected}`);
            log(`   connectionState: ${window.blockchainManager.wsMonitor.connectionState}`);
            
            try {
                log('ðŸ”Œ Attempting WebSocket connection via blockchain manager...');
                const success = await window.blockchainManager.wsMonitor.connect();
                
                if (success) {
                    log('âœ… WebSocket connection successful!');
                    log(`   Connected endpoint: ${window.blockchainManager.wsMonitor.currentEndpointIndex}`);
                } else {
                    log('âŒ WebSocket connection failed');
                }
            } catch (error) {
                log(`âŒ Error: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            logElement = document.getElementById('log');
            log('ðŸš€ Simple WebSocket Test initialized');
            
            // Wait for blockchain manager
            setTimeout(() => {
                if (typeof window.blockchainManager !== 'undefined') {
                    log('âœ… Blockchain manager auto-detected');
                } else {
                    log('âš ï¸ Blockchain manager not found after 2 seconds');
                }
            }, 2000);
        });

        window.addEventListener('blockchainReady', (event) => {
            log('ðŸŽ‰ Received blockchainReady event');
        });
    </script>
</body>
</html>