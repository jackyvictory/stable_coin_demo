<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Test Tool - Stable Coin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-title {
            color: #2328da;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .test-button {
            background: #2328da;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .test-button:hover {
            background: #1a1f9a;
        }

        .success-button {
            background: #28a745;
        }

        .success-button:hover {
            background: #218838;
        }

        .warning-button {
            background: #ffc107;
            color: #212529;
        }

        .warning-button:hover {
            background: #e0a800;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .step-list {
            list-style: none;
            padding: 0;
        }

        .step-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .step-list li:before {
            content: "✓ ";
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1 class="test-title">🧪 Payment Flow Test Tool</h1>

        <div class="info-box">
            <strong>Description:</strong> This tool helps you test payment flow navigation without requiring a web3 wallet.
        </div>

        <div class="test-section">
            <h3>📋 Test Steps</h3>
            <ul class="step-list">
                <li>Create mock payment data</li>
                <li>Navigate to QR code page</li>
                <li>Simulate payment success</li>
                <li>Verify navigation to success page</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🚀 Quick Test</h3>
            <p>Click the button below to start the complete payment flow test:</p>
            <button class="test-button success-button" onclick="startFullTest()">
                🎯 Start Complete Test Flow
            </button>
            <button class="test-button" onclick="createMockPayment()">
                📝 Create Mock Payment Data
            </button>
            <button class="test-button" onclick="goToQRCode()">
                📱 Go to QR Code Page
            </button>
            <button class="test-button success-button" onclick="simulatePaymentSuccess()">
                ✅ Simulate Payment Success
            </button>
        </div>

        <div class="test-section">
            <h3>🔧 Step-by-Step Test</h3>
            <p>If you want to test each step individually:</p>
            <button class="test-button" onclick="testProductSelection()">
                🛒 Test Product Selection Page
            </button>
            <button class="test-button" onclick="testPaymentSelection()">
                💳 Test Payment Selection Page
            </button>
            <button class="test-button warning-button" onclick="testQRCodePage()">
                📱 Test QR Code Page
            </button>
            <button class="test-button success-button" onclick="testSuccessPage()">
                🎉 Test Success Page
            </button>
        </div>

        <div class="test-section">
            <h3>🛠️ Debug Tools</h3>
            <button class="test-button" onclick="showCurrentPaymentData()">
                📊 View Current Payment Data
            </button>
            <button class="test-button" onclick="clearPaymentData()">
                🗑️ Clear Payment Data
            </button>
            <button class="test-button" onclick="showStorageInfo()">
                💾 View Storage Info
            </button>
        </div>

        <div id="output"
            style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 12px; display: none;">
        </div>
    </div>

    <script>
        // 输出日志函数
        function log(message) {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // 创建模拟支付数据
        function createMockPayment() {
            const mockPaymentData = {
                paymentId: 'test_' + Date.now(),
                product: 'rice',
                productName: 'Food Donation (Rice)',
                price: 5.00,
                currency: 'USD',
                status: 'waiting',
                timestamp: Date.now(),
                expiresAt: Date.now() + (30 * 60 * 1000), // 30分钟后过期
                selectedPayment: {
                    symbol: 'USDT',
                    name: 'Tether USD'
                },
                selectedNetwork: {
                    symbol: 'BSC',
                    name: 'BNB Smart Chain'
                },
                receiverAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04'
            };

            // 保存到 sessionStorage
            sessionStorage.setItem('paymentData', JSON.stringify(mockPaymentData));

            log('✅ Mock payment data created: ' + mockPaymentData.paymentId);
            log('💰 Amount: $' + mockPaymentData.price);
            log('🪙 Payment method: ' + mockPaymentData.selectedPayment.symbol);
            log('🌐 Network: ' + mockPaymentData.selectedNetwork.symbol);

            return mockPaymentData;
        }

        // 跳转到二维码页面
        function goToQRCode() {
            // 确保有支付数据
            const paymentData = sessionStorage.getItem('paymentData');
            if (!paymentData) {
                log('⚠️ No payment data found, creating mock data...');
                createMockPayment();
            }

            log('🔄 Navigating to QR code page...');
            setTimeout(() => {
                window.location.href = 'qrcode-ws.html';
            }, 1000);
        }

        // 模拟支付成功
        function simulatePaymentSuccess() {
            const paymentDataStr = sessionStorage.getItem('paymentData');
            if (!paymentDataStr) {
                log('❌ No payment data found');
                return;
            }

            const paymentData = JSON.parse(paymentDataStr);

            // 添加验证结果
            paymentData.verificationResult = {
                verified: true,
                transfer: {
                    transactionHash: '0x' + Math.random().toString(16).substr(2, 64),
                    blockNumber: Math.floor(Math.random() * 1000000) + 30000000,
                    formattedValue: paymentData.price.toString()
                },
                confirmations: 3,
                amount: paymentData.price.toString()
            };

            paymentData.status = 'confirmed';
            paymentData.confirmedAt = Date.now();

            // 更新存储
            sessionStorage.setItem('paymentData', JSON.stringify(paymentData));

            log('🎉 Payment success simulated!');
            log('📝 Transaction hash: ' + paymentData.verificationResult.transfer.transactionHash);
            log('🔄 Navigating to success page...');

            setTimeout(() => {
                window.location.href = 'success-ws.html';
            }, 2000);
        }

        // 开始完整测试流程
        function startFullTest() {
            log('🚀 Starting complete test flow...');

            // 1. 创建模拟支付数据
            const paymentData = createMockPayment();

            // 2. 等待一秒后跳转到二维码页面
            setTimeout(() => {
                log('📱 About to navigate to QR code page, please use debug features to test payment success...');
                log('💡 Tip: On the QR code page, click "⚙️ Debug" button, then click "🎯 Complete Flow Test"');

                setTimeout(() => {
                    window.location.href = 'qrcode-ws.html';
                }, 2000);
            }, 1000);
        }

        // 测试各个页面
        function testProductSelection() {
            log('🛒 Navigating to product selection page...');
            window.location.href = 'index.html';
        }

        function testPaymentSelection() {
            // 确保有基本的产品数据
            if (!sessionStorage.getItem('selectedProduct')) {
                sessionStorage.setItem('selectedProduct', JSON.stringify({
                    key: 'rice',
                    name: 'Food Donation (Rice)',
                    price: 5.00
                }));
            }
            log('💳 Navigating to payment selection page...');
            window.location.href = 'payment-ws.html';
        }

        function testQRCodePage() {
            createMockPayment();
            log('📱 Navigating to QR code page...');
            window.location.href = 'qrcode-ws.html';
        }

        function testSuccessPage() {
            createMockPayment();
            simulatePaymentSuccess();
        }

        // 调试工具
        function showCurrentPaymentData() {
            const paymentData = sessionStorage.getItem('paymentData');
            if (paymentData) {
                log('📊 Current payment data:');
                log(JSON.stringify(JSON.parse(paymentData), null, 2));
            } else {
                log('❌ No payment data found');
            }
        }

        function clearPaymentData() {
            sessionStorage.removeItem('paymentData');
            sessionStorage.removeItem('selectedProduct');
            sessionStorage.removeItem('currentPaymentId');
            log('🗑️ Payment data cleared');
        }

        function showStorageInfo() {
            log('💾 SessionStorage contents:');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                log(`${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function () {
            log('🧪 Payment test tool loaded');
            log('💡 You can use this tool to test payment flow without a real web3 wallet');
        });
    </script>
</body>

</html>