<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket äº‹ä»¶è§£æå™¨</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .raw-data {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .parsed-data {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        th:nth-child(1) { width: 12%; } /* å­—æ®µåˆ— */
        th:nth-child(2) { width: 22%; } /* åŸå§‹å€¼åˆ— */
        th:nth-child(3) { width: 33%; } /* è§£æç»“æœåˆ— */
        th:nth-child(4) { width: 33%; } /* è¯´æ˜åˆ— */
        
        /* è§£æç»“æœåˆ—æ ·å¼ */
        td:nth-child(3) {
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* è¯´æ˜åˆ—æ ·å¼ */
        td:nth-child(4) {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .raw-value-container {
            display: flex;
            align-items: center;
            gap: 5px;
            max-width: 100%;
            min-width: 0;
        }
        .raw-value {
            font-family: monospace;
            font-size: 11px;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 0;
        }
        .raw-value.short {
            word-break: break-all;
        }
        .raw-value.truncated {
            overflow: hidden;
        }
        .raw-value:hover {
            background-color: #e9ecef;
            border-color: #007bff;
        }
        .raw-value.expanded .truncated-text {
            display: none;
        }
        .raw-value.expanded .full-text {
            display: inline !important;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .expand-btn {
            font-size: 10px;
            color: #007bff;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .expand-btn:hover {
            color: #0056b3;
            background: #cce7ff;
        }
        .copy-btn {
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }
        .copy-hint {
            font-size: 10px;
            color: #6c757d;
            opacity: 0.7;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .btn.warning:hover {
            background: #e0a800;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .tooltip {
            position: relative;
            cursor: help;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebSocket äº‹ä»¶è§£æå™¨</h1>
        
        <div class="section">
            <h3>ğŸ“¥ è¾“å…¥ WebSocket äº‹ä»¶æ•°æ®</h3>
            <div style="margin-bottom: 15px;">
                <label for="eventInput" style="display: block; margin-bottom: 5px; font-weight: bold;">
                    ç²˜è´´ WebSocket æ¶ˆæ¯ (JSON æ ¼å¼):
                </label>
                <textarea 
                    id="eventInput" 
                    placeholder='ç²˜è´´å®Œæ•´çš„ WebSocket æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
{"jsonrpc":"2.0","method":"eth_subscription","params":{"result":{"address":"0x55d398326f99059ff775485246999027b3197955","blockHash":"0x...","blockNumber":"0x...","data":"0x...","topics":["0x...","0x...","0x..."],"transactionHash":"0x..."}}}

ğŸ’¡ æç¤º: 
- æ”¯æŒå®Œæ•´çš„ eth_subscription äº‹ä»¶æ¶ˆæ¯
- è‡ªåŠ¨è¯†åˆ« Transfer äº‹ä»¶å¹¶è§£æé‡‘é¢
- æŒ‰ Ctrl+Enter å¿«é€Ÿè§£æ' 
                    style="width: 100%; height: 150px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"
                ></textarea>
                <div class="input-group" style="margin-top: 10px;">
                    <button class="btn success" onclick="parseInputEvent()" data-tooltip="Ctrl+Enter å¿«æ·é”®">ğŸ” è§£æè¾“å…¥çš„äº‹ä»¶</button>
                    <button class="btn" onclick="loadSampleEvent()">ğŸ“‹ åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                    <button class="btn warning" onclick="clearInput()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                    <button class="btn" onclick="validateEventFormat()">âœ… éªŒè¯æ ¼å¼</button>
                </div>
            </div>
            
            <h4>ğŸ“„ å½“å‰è§£æçš„æ•°æ®:</h4>
            <div class="raw-data" id="rawData">
                ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ•°æ®"æˆ–è¾“å…¥ WebSocket æ¶ˆæ¯åç‚¹å‡»"è§£æè¾“å…¥çš„äº‹ä»¶"
            </div>
        </div>

        <div class="section">
            <h3>ğŸ§© äº‹ä»¶ç»“æ„è§£æ</h3>
            <div class="parsed-data">
                <table>
                    <tr>
                        <th>å­—æ®µ</th>
                        <th>åŸå§‹å€¼</th>
                        <th>è§£æç»“æœ</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tbody id="parseTable">
                        <!-- è§£æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ’° é‡‘é¢è®¡ç®—è¿‡ç¨‹</h3>
            <div id="amountCalculation">
                <!-- é‡‘é¢è®¡ç®—æ­¥éª¤å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="section">
            <h3>âœ… éªŒè¯ç»“æœ</h3>
            <div id="validationResult">
                <!-- éªŒè¯ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="section">
            <h3>ğŸ§ª æµ‹è¯•å·¥å…·</h3>
            <div class="input-group">
                <button class="btn" onclick="parseCurrentEvent()">ğŸ” é‡æ–°è§£æå½“å‰æ•°æ®</button>
                <button class="btn success" onclick="testWithCustomData()">ğŸ§ª æµ‹è¯• 1 USDT è½¬è´¦</button>
                <button class="btn" onclick="testWithDifferentAmounts()">ğŸ’° æµ‹è¯•ä¸åŒé‡‘é¢</button>
                <button class="btn" onclick="showCalculationSteps()">ğŸ“š æ˜¾ç¤ºè®¡ç®—æ­¥éª¤</button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“Š è§£æç»Ÿè®¡</h3>
            <div id="parseStats" style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                <p>è§£ææ¬¡æ•°: <span id="parseCount">0</span></p>
                <p>æˆåŠŸè§£æ: <span id="successCount">0</span></p>
                <p>è§£æé”™è¯¯: <span id="errorCount">0</span></p>
                <p>æœ€åè§£ææ—¶é—´: <span id="lastParseTime">æœªè§£æ</span></p>
            </div>
        </div>
    </div>

    <script>
        // è§£æç»Ÿè®¡
        let parseStats = {
            parseCount: 0,
            successCount: 0,
            errorCount: 0,
            lastParseTime: null
        };

        // å½“å‰äº‹ä»¶æ•°æ®
        let currentEventData = null;

        // ç¤ºä¾‹äº‹ä»¶æ•°æ®
        const sampleEventData = {
            "jsonrpc": "2.0",
            "method": "eth_subscription",
            "params": {
                "result": {
                    "address": "0x55d398326f99059ff775485246999027b3197955",
                    "blockHash": "0x1a9b609ef8387e42da82a3ab14af54e9d6130b639051f395a04267a222017430",
                    "blockNumber": "0x37de737",
                    "data": "0x000000000000000000000000000000000000000000000000002386f26fc10000",
                    "logIndex": "0x2c",
                    "removed": false,
                    "topics": [
                        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                        "0x000000000000000000000000d87caca31c0c10110b6132bddf88221f60ff6341",
                        "0x000000000000000000000000e27577b0e3920ce35f100f66430de0108cb78a04"
                    ],
                    "transactionHash": "0xb13914079964c6bbbc84ddc2522cf14b0c33c199d78af46c92bbe7c98df12118",
                    "transactionIndex": "0xb"
                },
                "subscription": "0xde291796e7713e8c30083ad3652d496a"
            }
        };

        // Transfer äº‹ä»¶ç­¾å
        const TRANSFER_SIGNATURE = "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";
        
        // ç›®æ ‡æ”¶æ¬¾åœ°å€
        const TARGET_ADDRESS = "0xe27577b0e3920ce35f100f66430de0108cb78a04";

        // ä»£å¸é…ç½®
        const TOKENS = {
            "0x55d398326f99059ff775485246999027b3197955": {
                symbol: "USDT",
                name: "Tether USD",
                decimals: 18
            }
        };

        // æ ¼å¼åŒ–åŸå§‹å€¼æ˜¾ç¤ºï¼ˆæ”¯æŒçœç•¥å’Œå±•å¼€ï¼‰
        function formatRawValue(value, maxLength = 40) {
            if (!value || value.length <= maxLength) {
                return `
                    <div class="raw-value-container">
                        <span class="raw-value short" onclick="copyToClipboard('${value}')" title="ç‚¹å‡»å¤åˆ¶">${value}</span>
                        <span class="copy-hint">ğŸ“‹</span>
                    </div>
                `;
            }
            
            const id = 'raw_' + Math.random().toString(36).substr(2, 9);
            const startLength = 12;
            const endLength = 12;
            const truncated = value.substring(0, startLength) + '...' + value.substring(value.length - endLength);
            
            return `
                <div class="raw-value-container" id="${id}">
                    <span class="raw-value truncated" onclick="toggleRawValue('${id}')" title="ç‚¹å‡»å±•å¼€/æ”¶èµ·">
                        <span class="truncated-text">${truncated}</span>
                        <span class="full-text" style="display: none;">${value}</span>
                    </span>
                    <span class="expand-btn" onclick="toggleRawValue('${id}')">[å±•å¼€]</span>
                    <span class="copy-btn" onclick="copyToClipboard('${value}')" title="å¤åˆ¶å®Œæ•´å€¼">ğŸ“‹</span>
                </div>
            `;
        }

        // åˆ‡æ¢åŸå§‹å€¼çš„æ˜¾ç¤ºçŠ¶æ€
        function toggleRawValue(id) {
            const container = document.getElementById(id);
            if (!container) return;
            
            const rawValue = container.querySelector('.raw-value');
            const expandBtn = container.querySelector('.expand-btn');
            
            if (rawValue.classList.contains('truncated')) {
                // å±•å¼€
                rawValue.classList.remove('truncated');
                rawValue.classList.add('expanded');
                expandBtn.textContent = '[æ”¶èµ·]';
            } else {
                // æ”¶èµ·
                rawValue.classList.remove('expanded');
                rawValue.classList.add('truncated');
                expandBtn.textContent = '[å±•å¼€]';
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                // ä½¿ç”¨ç°ä»£ Clipboard API
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(text);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    console.error('å¤åˆ¶å‘½ä»¤å¤±è´¥');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            }
            
            document.body.removeChild(textArea);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            // åˆ›å»ºä¸´æ—¶æç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.getElementById('toast-style')) {
                const style = document.createElement('style');
                style.id = 'toast-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 2ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        // æ›´æ–°è§£æç»Ÿè®¡
        function updateParseStats(success = true) {
            parseStats.parseCount++;
            if (success) {
                parseStats.successCount++;
            } else {
                parseStats.errorCount++;
            }
            parseStats.lastParseTime = new Date().toLocaleString();
            
            document.getElementById('parseCount').textContent = parseStats.parseCount;
            document.getElementById('successCount').textContent = parseStats.successCount;
            document.getElementById('errorCount').textContent = parseStats.errorCount;
            document.getElementById('lastParseTime').textContent = parseStats.lastParseTime;
        }

        // è§£æè¾“å…¥çš„äº‹ä»¶
        function parseInputEvent() {
            const input = document.getElementById('eventInput').value.trim();
            
            if (!input) {
                alert('è¯·å…ˆè¾“å…¥ WebSocket äº‹ä»¶æ•°æ®ï¼');
                return;
            }
            
            try {
                // å°è¯•è§£æ JSON
                const eventData = JSON.parse(input);
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (!validateEventStructure(eventData)) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿æ˜¯å®Œæ•´çš„ WebSocket äº‹ä»¶æ¶ˆæ¯');
                }
                
                currentEventData = eventData;
                console.log('ğŸ“¥ è§£æè¾“å…¥çš„äº‹ä»¶æ•°æ®:', eventData);
                
                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                displayRawData(eventData);
                
                // è§£æå¹¶æ˜¾ç¤ºç»“æœ
                parseCurrentEvent();
                
                updateParseStats(true);
                
            } catch (error) {
                console.error('âŒ è§£æé”™è¯¯:', error);
                alert(`è§£æå¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥è¾“å…¥çš„ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`);
                updateParseStats(false);
            }
        }

        // éªŒè¯äº‹ä»¶æ•°æ®ç»“æ„
        function validateEventStructure(eventData) {
            try {
                // æ£€æŸ¥åŸºæœ¬ç»“æ„
                if (!eventData.method || eventData.method !== 'eth_subscription') {
                    return false;
                }
                
                if (!eventData.params || !eventData.params.result) {
                    return false;
                }
                
                const result = eventData.params.result;
                
                // æ£€æŸ¥å¿…è¦å­—æ®µ
                const requiredFields = ['address', 'topics', 'data', 'transactionHash', 'blockNumber'];
                for (const field of requiredFields) {
                    if (!result[field]) {
                        return false;
                    }
                }
                
                // æ£€æŸ¥ topics æ•°ç»„
                if (!Array.isArray(result.topics) || result.topics.length < 3) {
                    return false;
                }
                
                return true;
            } catch (error) {
                return false;
            }
        }

        // åŠ è½½ç¤ºä¾‹äº‹ä»¶
        function loadSampleEvent() {
            const sampleJson = JSON.stringify(sampleEventData, null, 2);
            document.getElementById('eventInput').value = sampleJson;
            
            console.log('ğŸ“‹ åŠ è½½ç¤ºä¾‹æ•°æ®');
            parseInputEvent();
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('eventInput').value = '';
            document.getElementById('rawData').textContent = 'è¾“å…¥å·²æ¸…ç©ºï¼Œè¯·ç²˜è´´æ–°çš„ WebSocket æ¶ˆæ¯';
            
            // æ¸…ç©ºè§£æç»“æœ
            document.getElementById('parseTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">è¯·è¾“å…¥äº‹ä»¶æ•°æ®å¹¶è§£æ</td></tr>';
            document.getElementById('amountCalculation').innerHTML = '<p style="color: #666;">è¯·å…ˆè§£æäº‹ä»¶æ•°æ®</p>';
            document.getElementById('validationResult').innerHTML = '<p style="color: #666;">è¯·å…ˆè§£æäº‹ä»¶æ•°æ®</p>';
            
            currentEventData = null;
            console.log('ğŸ—‘ï¸ è¾“å…¥å·²æ¸…ç©º');
        }

        // éªŒè¯äº‹ä»¶æ ¼å¼
        function validateEventFormat() {
            const input = document.getElementById('eventInput').value.trim();
            
            if (!input) {
                alert('è¯·å…ˆè¾“å…¥äº‹ä»¶æ•°æ®ï¼');
                return;
            }
            
            try {
                const eventData = JSON.parse(input);
                const isValid = validateEventStructure(eventData);
                
                if (isValid) {
                    alert('âœ… äº‹ä»¶æ ¼å¼éªŒè¯é€šè¿‡ï¼\n\nè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ WebSocket Transfer äº‹ä»¶ã€‚');
                } else {
                    alert('âŒ äº‹ä»¶æ ¼å¼éªŒè¯å¤±è´¥ï¼\n\nè¯·æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´çš„ eth_subscription äº‹ä»¶æ¶ˆæ¯ã€‚');
                }
            } catch (error) {
                alert(`âŒ JSON æ ¼å¼é”™è¯¯ï¼\n\n${error.message}`);
            }
        }

        // æµ‹è¯•ä¸åŒé‡‘é¢
        function testWithDifferentAmounts() {
            const amounts = [
                { hex: "0x0de0b6b3a7640000", decimal: "1.0", desc: "1 USDT" },
                { hex: "0x01bc16d674ec80000", decimal: "0.5", desc: "0.5 USDT" },
                { hex: "0x00038d7ea4c68000", decimal: "0.001", desc: "0.001 USDT" },
                { hex: "0x152d02c7e14af6800000", decimal: "100.0", desc: "100 USDT" }
            ];
            
            let testResults = "ğŸ§ª ä¸åŒé‡‘é¢æµ‹è¯•ç»“æœ:\n\n";
            
            amounts.forEach(amount => {
                const testData = {
                    ...sampleEventData,
                    params: {
                        ...sampleEventData.params,
                        result: {
                            ...sampleEventData.params.result,
                            data: amount.hex
                        }
                    }
                };
                
                const parsed = parseTransferEvent(testData);
                testResults += `${amount.desc}: ${parsed.amount} ${parsed.tokenSymbol}\n`;
            });
            
            alert(testResults);
        }

        // è§£æäº‹ä»¶æ•°æ®
        function parseTransferEvent(eventData) {
            const result = eventData.params.result;
            
            // åŸºæœ¬ä¿¡æ¯
            const contractAddress = result.address.toLowerCase();
            const blockNumber = parseInt(result.blockNumber, 16);
            const transactionHash = result.transactionHash;
            const topics = result.topics;
            const data = result.data;

            // è§£æ Transfer äº‹ä»¶
            const eventSignature = topics[0];
            const fromAddressRaw = topics[1];
            const toAddressRaw = topics[2];

            // æå–åœ°å€ (å»æ‰å‰é¢çš„0å¡«å……)
            const fromAddress = "0x" + fromAddressRaw.slice(26);
            const toAddress = "0x" + toAddressRaw.slice(26);

            // è§£æé‡‘é¢
            const amountWei = BigInt(data);
            const token = TOKENS[contractAddress];
            const decimals = token ? token.decimals : 18;
            const amount = Number(amountWei) / Math.pow(10, decimals);

            return {
                // åŸºæœ¬ä¿¡æ¯
                contractAddress,
                tokenSymbol: token ? token.symbol : "UNKNOWN",
                tokenName: token ? token.name : "Unknown Token",
                blockNumber,
                transactionHash,
                
                // Transfer è¯¦æƒ…
                eventSignature,
                fromAddress,
                toAddress,
                amountWei: amountWei.toString(),
                amount,
                decimals,
                
                // éªŒè¯
                isTransferEvent: eventSignature === TRANSFER_SIGNATURE,
                isToTargetAddress: toAddress.toLowerCase() === TARGET_ADDRESS.toLowerCase(),
                
                // åŸå§‹æ•°æ®
                rawTopics: topics,
                rawData: data
            };
        }

        // æ˜¾ç¤ºåŸå§‹æ•°æ®
        function displayRawData(eventData = null) {
            const rawDataElement = document.getElementById('rawData');
            const dataToShow = eventData || currentEventData || sampleEventData;
            rawDataElement.textContent = JSON.stringify(dataToShow, null, 2);
        }

        // æ˜¾ç¤ºè§£æç»“æœ
        function displayParseResults(parsed) {
            const tableBody = document.getElementById('parseTable');
            
            const rows = [
                {
                    field: "åˆçº¦åœ°å€",
                    raw: parsed.contractAddress,
                    parsed: `${parsed.tokenSymbol} (${parsed.tokenName})`,
                    description: "ä»£å¸åˆçº¦åœ°å€"
                },
                {
                    field: "äº‹ä»¶ç­¾å",
                    raw: parsed.eventSignature,
                    parsed: parsed.isTransferEvent ? "âœ… Transfer äº‹ä»¶" : "âŒ é Transfer äº‹ä»¶",
                    description: "keccak256('Transfer(address,address,uint256)')"
                },
                {
                    field: "åŒºå—å·",
                    raw: (currentEventData || sampleEventData).params.result.blockNumber,
                    parsed: `${parsed.blockNumber}`,
                    description: "äº¤æ˜“æ‰€åœ¨åŒºå—"
                },
                {
                    field: "å‘é€åœ°å€ (From)",
                    raw: parsed.rawTopics[1],
                    parsed: parsed.fromAddress,
                    description: "topics[1] å»æ‰å‰12å­—èŠ‚å¡«å……"
                },
                {
                    field: "æ¥æ”¶åœ°å€ (To)",
                    raw: parsed.rawTopics[2],
                    parsed: `${parsed.toAddress} ${parsed.isToTargetAddress ? 'âœ…' : 'âŒ'}`,
                    description: "topics[2] å»æ‰å‰12å­—èŠ‚å¡«å……"
                },
                {
                    field: "è½¬è´¦é‡‘é¢",
                    raw: parsed.rawData,
                    parsed: `${parsed.amount} ${parsed.tokenSymbol}`,
                    description: `data å­—æ®µè½¬æ¢ (${parsed.decimals} ä½å°æ•°)`
                }
            ];

            tableBody.innerHTML = rows.map(row => `
                <tr>
                    <td><strong>${row.field}</strong></td>
                    <td>${formatRawValue(row.raw)}</td>
                    <td><span class="${row.parsed.includes('âœ…') ? 'success' : row.parsed.includes('âŒ') ? 'warning' : 'info'}">${row.parsed}</span></td>
                    <td>${row.description}</td>
                </tr>
            `).join('');
        }

        // æ˜¾ç¤ºé‡‘é¢è®¡ç®—è¿‡ç¨‹
        function displayAmountCalculation(parsed) {
            const calculationElement = document.getElementById('amountCalculation');
            
            calculationElement.innerHTML = `
                <h4>ğŸ’» é€æ­¥è®¡ç®—è¿‡ç¨‹ï¼š</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
                    <p><strong>1. åŸå§‹åå…­è¿›åˆ¶æ•°æ®ï¼š</strong></p>
                    <code>${parsed.rawData}</code>
                    
                    <p><strong>2. è½¬æ¢ä¸º BigIntï¼š</strong></p>
                    <code>BigInt("${parsed.rawData}") = ${parsed.amountWei}n</code>
                    
                    <p><strong>3. è½¬æ¢ä¸ºåè¿›åˆ¶æ•°å­—ï¼š</strong></p>
                    <code>Number(${parsed.amountWei}n) = ${Number(parsed.amountWei)}</code>
                    
                    <p><strong>4. åº”ç”¨ä»£å¸å°æ•°ä½æ•°ï¼š</strong></p>
                    <code>${Number(parsed.amountWei)} Ã· 10^${parsed.decimals} = ${parsed.amount}</code>
                    
                    <p><strong>5. æœ€ç»ˆç»“æœï¼š</strong></p>
                    <code class="success">${parsed.amount} ${parsed.tokenSymbol}</code>
                </div>
                
                <h4>ğŸ”¢ åå…­è¿›åˆ¶è½¬æ¢éªŒè¯ï¼š</h4>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 5px;">
                    <p>åå…­è¿›åˆ¶: <code>0x2386f26fc10000</code></p>
                    <p>äºŒè¿›åˆ¶: <code>${parseInt('2386f26fc10000', 16).toString(2)}</code></p>
                    <p>åè¿›åˆ¶: <code>${parseInt('2386f26fc10000', 16)}</code></p>
                    <p>ç§‘å­¦è®¡æ•°æ³•: <code>${parseInt('2386f26fc10000', 16).toExponential()}</code></p>
                </div>
            `;
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayValidationResult(parsed) {
            const validationElement = document.getElementById('validationResult');
            
            const checks = [
                {
                    name: "æ˜¯å¦ä¸º Transfer äº‹ä»¶",
                    result: parsed.isTransferEvent,
                    details: `äº‹ä»¶ç­¾ååŒ¹é…: ${parsed.eventSignature === TRANSFER_SIGNATURE ? 'âœ…' : 'âŒ'}`
                },
                {
                    name: "æ˜¯å¦å‘é€åˆ°ç›®æ ‡åœ°å€",
                    result: parsed.isToTargetAddress,
                    details: `ç›®æ ‡åœ°å€: ${TARGET_ADDRESS}`
                },
                {
                    name: "ä»£å¸ç±»å‹è¯†åˆ«",
                    result: parsed.tokenSymbol !== "UNKNOWN",
                    details: `è¯†åˆ«ä¸º: ${parsed.tokenSymbol} (${parsed.tokenName})`
                },
                {
                    name: "é‡‘é¢è§£æ",
                    result: parsed.amount > 0,
                    details: `è§£æé‡‘é¢: ${parsed.amount} ${parsed.tokenSymbol}`
                }
            ];

            const allPassed = checks.every(check => check.result);

            validationElement.innerHTML = `
                <div style="padding: 15px; border-radius: 5px; background: ${allPassed ? '#d4edda' : '#f8d7da'}; border: 1px solid ${allPassed ? '#c3e6cb' : '#f5c6cb'};">
                    <h4 style="margin-top: 0; color: ${allPassed ? '#155724' : '#721c24'};">
                        ${allPassed ? 'ğŸ‰ éªŒè¯é€šè¿‡ï¼' : 'âš ï¸ éªŒè¯å¤±è´¥ï¼'}
                    </h4>
                    ${checks.map(check => `
                        <p style="margin: 5px 0;">
                            ${check.result ? 'âœ…' : 'âŒ'} <strong>${check.name}</strong>: ${check.details}
                        </p>
                    `).join('')}
                </div>
                
                ${allPassed ? `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <h4 style="margin-top: 0; color: #856404;">ğŸ“Š äº¤æ˜“æ‘˜è¦</h4>
                        <p><strong>äº¤æ˜“å“ˆå¸Œ:</strong> <code>${parsed.transactionHash}</code></p>
                        <p><strong>åŒºå—å·:</strong> ${parsed.blockNumber}</p>
                        <p><strong>å‘é€æ–¹:</strong> <code>${parsed.fromAddress}</code></p>
                        <p><strong>æ¥æ”¶æ–¹:</strong> <code>${parsed.toAddress}</code></p>
                        <p><strong>é‡‘é¢:</strong> <span class="success">${parsed.amount} ${parsed.tokenSymbol}</span></p>
                        <p><strong>ä»£å¸åˆçº¦:</strong> <code>${parsed.contractAddress}</code></p>
                    </div>
                ` : ''}
            `;
        }

        // è§£æå½“å‰äº‹ä»¶
        function parseCurrentEvent() {
            const eventData = currentEventData || sampleEventData;
            
            if (!eventData) {
                alert('æ²¡æœ‰å¯è§£æçš„äº‹ä»¶æ•°æ®ï¼è¯·å…ˆè¾“å…¥æˆ–åŠ è½½ç¤ºä¾‹æ•°æ®ã€‚');
                return;
            }
            
            console.log('ğŸ” å¼€å§‹è§£æäº‹ä»¶æ•°æ®...');
            
            try {
                const parsed = parseTransferEvent(eventData);
                console.log('ğŸ“Š è§£æç»“æœ:', parsed);
                
                displayParseResults(parsed);
                displayAmountCalculation(parsed);
                displayValidationResult(parsed);
                
                updateParseStats(true);
            } catch (error) {
                console.error('âŒ è§£æé”™è¯¯:', error);
                alert(`è§£æå¤±è´¥: ${error.message}`);
                updateParseStats(false);
            }
        }

        // æµ‹è¯•è‡ªå®šä¹‰æ•°æ® (1 USDT)
        function testWithCustomData() {
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„äº‹ä»¶æ•°æ® (1 USDT)
            const testData = {
                ...sampleEventData,
                params: {
                    ...sampleEventData.params,
                    result: {
                        ...sampleEventData.params.result,
                        data: "0x0000000000000000000000000000000000000000000000000de0b6b3a7640000", // 1 USDT
                        transactionHash: "0x" + Math.random().toString(16).substr(2, 64) // éšæœºäº¤æ˜“å“ˆå¸Œ
                    }
                }
            };
            
            console.log('ğŸ§ª æµ‹è¯• 1 USDT è½¬è´¦æ•°æ®');
            
            // ä¸´æ—¶è®¾ç½®ä¸ºå½“å‰æ•°æ®å¹¶è§£æ
            const originalData = currentEventData;
            currentEventData = testData;
            
            displayRawData(testData);
            parseCurrentEvent();
            
            // æ¢å¤åŸå§‹æ•°æ®
            currentEventData = originalData;
            
            alert('ğŸ§ª å·²åŠ è½½ 1 USDT æµ‹è¯•æ•°æ®ï¼ŒæŸ¥çœ‹è§£æç»“æœï¼');
        }

        // æ˜¾ç¤ºè®¡ç®—æ­¥éª¤
        function showCalculationSteps() {
            const steps = `
WebSocket äº‹ä»¶è§£ææ­¥éª¤ï¼š

1. è¯†åˆ«äº‹ä»¶ç±»å‹
   - æ£€æŸ¥ topics[0] æ˜¯å¦ä¸º Transfer äº‹ä»¶ç­¾å
   - Transfer ç­¾å: 0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef

2. è§£æåœ°å€ä¿¡æ¯
   - topics[1]: from åœ°å€ (32å­—èŠ‚ï¼Œå‰12å­—èŠ‚ä¸º0å¡«å……)
   - topics[2]: to åœ°å€ (32å­—èŠ‚ï¼Œå‰12å­—èŠ‚ä¸º0å¡«å……)
   - æå–æ–¹æ³•: "0x" + topic.slice(26)

3. è§£æè½¬è´¦é‡‘é¢
   - data å­—æ®µåŒ…å« uint256 é‡‘é¢ (32å­—èŠ‚)
   - è½¬æ¢ä¸º BigInt: BigInt(data)
   - åº”ç”¨å°æ•°ä½æ•°: amount / 10^decimals

4. éªŒè¯ç›®æ ‡åœ°å€
   - æ£€æŸ¥ to åœ°å€æ˜¯å¦åŒ¹é…æ”¶æ¬¾åœ°å€
   - å¤§å°å†™ä¸æ•æ„Ÿæ¯”è¾ƒ

5. è¯†åˆ«ä»£å¸ç±»å‹
   - æ ¹æ®åˆçº¦åœ°å€æŸ¥æ‰¾ä»£å¸ä¿¡æ¯
   - è·å–ç¬¦å·ã€åç§°ã€å°æ•°ä½æ•°
            `;
            
            alert(steps);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ WebSocket äº‹ä»¶è§£æå™¨å·²åŠ è½½');
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            document.getElementById('rawData').textContent = 'è¯·è¾“å…¥ WebSocket äº‹ä»¶æ•°æ®æˆ–ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ•°æ®"';
            
            // åˆå§‹åŒ–è§£æç»“æœè¡¨æ ¼
            document.getElementById('parseTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">è¯·è¾“å…¥äº‹ä»¶æ•°æ®å¹¶è§£æ</td></tr>';
            document.getElementById('amountCalculation').innerHTML = '<p style="color: #666;">è¯·å…ˆè§£æäº‹ä»¶æ•°æ®</p>';
            document.getElementById('validationResult').innerHTML = '<p style="color: #666;">è¯·å…ˆè§£æäº‹ä»¶æ•°æ®</p>';
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateParseStats(true);
            parseStats.parseCount = 0; // é‡ç½®è®¡æ•°
            updateParseStats(true);
            parseStats.parseCount = 0;
            parseStats.successCount = 0;
            parseStats.errorCount = 0;
            parseStats.lastParseTime = null;
            
            document.getElementById('parseCount').textContent = '0';
            document.getElementById('successCount').textContent = '0';
            document.getElementById('errorCount').textContent = '0';
            document.getElementById('lastParseTime').textContent = 'æœªè§£æ';
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.getElementById('eventInput').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    parseInputEvent();
                }
            });
            
            console.log('ğŸ’¡ æç¤º: ç²˜è´´ WebSocket æ¶ˆæ¯åæŒ‰ Ctrl+Enter å¿«é€Ÿè§£æ');
        });
    </script>
</body>
</html>