<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æµ‹è¯•å·¥å…· - EVO Payment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2328da;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #2328da;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #1a1f9a;
        }
        .success-button {
            background: #28a745;
        }
        .success-button:hover {
            background: #218838;
        }
        .warning-button {
            background: #ffc107;
            color: #212529;
        }
        .warning-button:hover {
            background: #e0a800;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .step-list {
            list-style: none;
            padding: 0;
        }
        .step-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .step-list li:before {
            content: "âœ“ ";
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">ğŸ§ª æ”¯ä»˜æµç¨‹æµ‹è¯•å·¥å…·</h1>
        
        <div class="info-box">
            <strong>è¯´æ˜ï¼š</strong>è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©ä½ åœ¨æ²¡æœ‰ web3 é’±åŒ…çš„æƒ…å†µä¸‹æµ‹è¯•æ”¯ä»˜æµç¨‹çš„è·³è½¬åŠŸèƒ½ã€‚
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <ul class="step-list">
                <li>åˆ›å»ºæ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®</li>
                <li>è·³è½¬åˆ°äºŒç»´ç é¡µé¢</li>
                <li>æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ</li>
                <li>éªŒè¯è·³è½¬åˆ°æˆåŠŸé¡µé¢</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸš€ å¿«é€Ÿæµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹å®Œæ•´çš„æ”¯ä»˜æµç¨‹æµ‹è¯•ï¼š</p>
            <button class="test-button success-button" onclick="startFullTest()">
                ğŸ¯ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹
            </button>
            <button class="test-button" onclick="createMockPayment()">
                ğŸ“ åˆ›å»ºæ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®
            </button>
            <button class="test-button" onclick="goToQRCode()">
                ğŸ“± è·³è½¬åˆ°äºŒç»´ç é¡µé¢
            </button>
            <button class="test-button success-button" onclick="simulatePaymentSuccess()">
                âœ… æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
            </button>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ å•æ­¥æµ‹è¯•</h3>
            <p>å¦‚æœä½ æƒ³åˆ†æ­¥æµ‹è¯•æ¯ä¸ªç¯èŠ‚ï¼š</p>
            <button class="test-button" onclick="testProductSelection()">
                ğŸ›’ æµ‹è¯•äº§å“é€‰æ‹©é¡µ
            </button>
            <button class="test-button" onclick="testPaymentSelection()">
                ğŸ’³ æµ‹è¯•æ”¯ä»˜é€‰æ‹©é¡µ
            </button>
            <button class="test-button warning-button" onclick="testQRCodePage()">
                ğŸ“± æµ‹è¯•äºŒç»´ç é¡µé¢
            </button>
            <button class="test-button success-button" onclick="testSuccessPage()">
                ğŸ‰ æµ‹è¯•æˆåŠŸé¡µé¢
            </button>
        </div>

        <div class="test-section">
            <h3>ğŸ› ï¸ è°ƒè¯•å·¥å…·</h3>
            <button class="test-button" onclick="showCurrentPaymentData()">
                ğŸ“Š æŸ¥çœ‹å½“å‰æ”¯ä»˜æ•°æ®
            </button>
            <button class="test-button" onclick="clearPaymentData()">
                ğŸ—‘ï¸ æ¸…é™¤æ”¯ä»˜æ•°æ®
            </button>
            <button class="test-button" onclick="showStorageInfo()">
                ğŸ’¾ æŸ¥çœ‹å­˜å‚¨ä¿¡æ¯
            </button>
        </div>

        <div id="output" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 12px; display: none;">
        </div>
    </div>

    <script>
        // è¾“å‡ºæ—¥å¿—å‡½æ•°
        function log(message) {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        // åˆ›å»ºæ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®
        function createMockPayment() {
            const mockPaymentData = {
                paymentId: 'test_' + Date.now(),
                product: 'rice',
                productName: 'Food Donation (Rice)',
                price: 5.00,
                currency: 'USD',
                status: 'waiting',
                timestamp: Date.now(),
                expiresAt: Date.now() + (30 * 60 * 1000), // 30åˆ†é’Ÿåè¿‡æœŸ
                selectedPayment: {
                    symbol: 'USDT',
                    name: 'Tether USD'
                },
                selectedNetwork: {
                    symbol: 'BSC',
                    name: 'BNB Smart Chain'
                },
                receiverAddress: '0xe27577B0e3920cE35f100f66430de0108cb78a04'
            };

            // ä¿å­˜åˆ° sessionStorage
            sessionStorage.setItem('paymentData', JSON.stringify(mockPaymentData));
            
            log('âœ… æ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®å·²åˆ›å»º: ' + mockPaymentData.paymentId);
            log('ğŸ’° é‡‘é¢: $' + mockPaymentData.price);
            log('ğŸª™ æ”¯ä»˜æ–¹å¼: ' + mockPaymentData.selectedPayment.symbol);
            log('ğŸŒ ç½‘ç»œ: ' + mockPaymentData.selectedNetwork.symbol);
            
            return mockPaymentData;
        }

        // è·³è½¬åˆ°äºŒç»´ç é¡µé¢
        function goToQRCode() {
            // ç¡®ä¿æœ‰æ”¯ä»˜æ•°æ®
            const paymentData = sessionStorage.getItem('paymentData');
            if (!paymentData) {
                log('âš ï¸ æ²¡æœ‰æ”¯ä»˜æ•°æ®ï¼Œå…ˆåˆ›å»ºæ¨¡æ‹Ÿæ•°æ®...');
                createMockPayment();
            }
            
            log('ğŸ”„ è·³è½¬åˆ°äºŒç»´ç é¡µé¢...');
            setTimeout(() => {
                window.location.href = 'qrcode.html';
            }, 1000);
        }

        // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
        function simulatePaymentSuccess() {
            const paymentDataStr = sessionStorage.getItem('paymentData');
            if (!paymentDataStr) {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°æ”¯ä»˜æ•°æ®');
                return;
            }

            const paymentData = JSON.parse(paymentDataStr);
            
            // æ·»åŠ éªŒè¯ç»“æœ
            paymentData.verificationResult = {
                verified: true,
                transfer: {
                    transactionHash: '0x' + Math.random().toString(16).substr(2, 64),
                    blockNumber: Math.floor(Math.random() * 1000000) + 30000000,
                    formattedValue: paymentData.price.toString()
                },
                confirmations: 3,
                amount: paymentData.price.toString()
            };
            
            paymentData.status = 'confirmed';
            paymentData.confirmedAt = Date.now();
            
            // æ›´æ–°å­˜å‚¨
            sessionStorage.setItem('paymentData', JSON.stringify(paymentData));
            
            log('ğŸ‰ æ”¯ä»˜æˆåŠŸå·²æ¨¡æ‹Ÿï¼');
            log('ğŸ“ äº¤æ˜“å“ˆå¸Œ: ' + paymentData.verificationResult.transfer.transactionHash);
            log('ğŸ”„ è·³è½¬åˆ°æˆåŠŸé¡µé¢...');
            
            setTimeout(() => {
                window.location.href = 'success.html';
            }, 2000);
        }

        // å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹
        function startFullTest() {
            log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...');
            
            // 1. åˆ›å»ºæ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®
            const paymentData = createMockPayment();
            
            // 2. ç­‰å¾…ä¸€ç§’åè·³è½¬åˆ°äºŒç»´ç é¡µé¢
            setTimeout(() => {
                log('ğŸ“± å³å°†è·³è½¬åˆ°äºŒç»´ç é¡µé¢ï¼Œè¯·åœ¨è¯¥é¡µé¢ä½¿ç”¨è°ƒè¯•åŠŸèƒ½æµ‹è¯•æ”¯ä»˜æˆåŠŸ...');
                log('ğŸ’¡ æç¤ºï¼šåœ¨äºŒç»´ç é¡µé¢ç‚¹å‡» "âš™ï¸ Debug" æŒ‰é’®ï¼Œç„¶åç‚¹å‡» "ğŸ¯ Complete Flow Test"');
                
                setTimeout(() => {
                    window.location.href = 'qrcode.html';
                }, 2000);
            }, 1000);
        }

        // æµ‹è¯•å„ä¸ªé¡µé¢
        function testProductSelection() {
            log('ğŸ›’ è·³è½¬åˆ°äº§å“é€‰æ‹©é¡µ...');
            window.location.href = 'index.html';
        }

        function testPaymentSelection() {
            // ç¡®ä¿æœ‰åŸºæœ¬çš„äº§å“æ•°æ®
            if (!sessionStorage.getItem('selectedProduct')) {
                sessionStorage.setItem('selectedProduct', JSON.stringify({
                    key: 'rice',
                    name: 'Food Donation (Rice)',
                    price: 5.00
                }));
            }
            log('ğŸ’³ è·³è½¬åˆ°æ”¯ä»˜é€‰æ‹©é¡µ...');
            window.location.href = 'payment.html';
        }

        function testQRCodePage() {
            createMockPayment();
            log('ğŸ“± è·³è½¬åˆ°äºŒç»´ç é¡µé¢...');
            window.location.href = 'qrcode.html';
        }

        function testSuccessPage() {
            createMockPayment();
            simulatePaymentSuccess();
        }

        // è°ƒè¯•å·¥å…·
        function showCurrentPaymentData() {
            const paymentData = sessionStorage.getItem('paymentData');
            if (paymentData) {
                log('ğŸ“Š å½“å‰æ”¯ä»˜æ•°æ®:');
                log(JSON.stringify(JSON.parse(paymentData), null, 2));
            } else {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°æ”¯ä»˜æ•°æ®');
            }
        }

        function clearPaymentData() {
            sessionStorage.removeItem('paymentData');
            sessionStorage.removeItem('selectedProduct');
            sessionStorage.removeItem('currentPaymentId');
            log('ğŸ—‘ï¸ æ”¯ä»˜æ•°æ®å·²æ¸…é™¤');
        }

        function showStorageInfo() {
            log('ğŸ’¾ SessionStorage å†…å®¹:');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                log(`${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ§ª æ”¯ä»˜æµ‹è¯•å·¥å…·å·²åŠ è½½');
            log('ğŸ’¡ ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥æµ‹è¯•æ”¯ä»˜æµç¨‹ï¼Œæ— éœ€çœŸå®çš„ web3 é’±åŒ…');
        });
    </script>
</body>
</html>