# WebSocket 支付监听系统实施任务

## 实施任务列表

- [ ] 1. 创建基础文件结构和页面
  - 从原版文件复制创建所有 -ws 版本文件
  - 修改页面间的跳转链接指向 -ws 版本
  - 在首页添加 WebSocket 版本入口按钮
  - _需求: 1.1, 1.2, 1.3, 8.1, 8.2_

- [ ] 1.1 复制并创建 HTML 页面文件
  - 复制 payment.html 创建 payment-ws.html
  - 复制 qrcode.html 创建 qrcode-ws.html  
  - 复制 success.html 创建 success-ws.html
  - 修改页面中的 JavaScript 引用指向 -ws 版本
  - _需求: 8.1, 8.4_

- [ ] 1.2 复制并创建 JavaScript 文件
  - 复制 js/payment.js 创建 js/payment-ws.js
  - 复制 js/qrcode.js 创建 js/qrcode-ws.js
  - 复制 js/success.js 创建 js/success-ws.js
  - 复制 js/payment-handler.js 创建 js/payment-handler-ws.js
  - 复制 js/blockchain.js 创建 js/blockchain-ws.js
  - _需求: 8.2, 8.6_

- [ ] 1.3 修改首页添加 WebSocket 入口
  - 在 index.html 的 "Pay With Stable Coin" 按钮下方添加不显眼的 "Pay With Stable Coin (ws)" 按钮
  - 设置按钮点击事件跳转到 payment-ws.html
  - 调整按钮样式使其不太显眼但可点击
  - _需求: 1.1_

- [ ] 1.4 修改页面跳转链接
  - 修改 payment-ws.html 中的跳转链接指向 qrcode-ws.html
  - 修改 qrcode-ws.html 中的跳转链接指向 success-ws.html
  - 修改返回按钮指向对应的 -ws 版本页面
  - _需求: 8.5_

- [ ] 2. 实现 WebSocket 监听管理器
  - 创建 WebSocketMonitor 类管理多端点连接
  - 实现按优先级顺序尝试连接所有端点的逻辑
  - 实现连接失败时的端点切换机制
  - 实现 newHeads 事件订阅和处理
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [ ] 2.1 创建 WebSocket 监听核心类
  - 在 js/blockchain-ws.js 中创建 WebSocketMonitor 类
  - 定义多个 BSC WebSocket 端点配置
  - 实现基本的连接和断开方法
  - 添加连接状态管理
  - _需求: 2.1_

- [ ] 2.2 实现多端点连接逻辑
  - 实现按顺序尝试所有端点的 connect() 方法
  - 添加连接超时和错误处理
  - 记录失败的端点信息
  - 只有所有端点都失败才返回 false
  - _需求: 2.1, 2.4_

- [ ] 2.3 实现 newHeads 事件订阅
  - 连接成功后订阅 newHeads 事件
  - 实现事件数据解析和验证
  - 添加事件处理器注册机制
  - 处理订阅失败的情况
  - _需求: 2.2_

- [ ] 2.4 实现重连和端点切换机制
  - 连接断开时自动尝试重连当前端点
  - 重连失败时切换到下一个端点
  - 实现定期重试失败端点的机制
  - 添加重连状态提示
  - _需求: 2.4, 2.5_

- [ ] 3. 实现独立的轮询备用机制
  - 在 blockchain-ws.js 中独立实现轮询逻辑
  - 实现优化的区块检查策略
  - 确保与 WebSocket 模式的无缝切换
  - 避免重复检查同一区块
  - _需求: 3.1, 3.2, 3.3, 3.5, 3.6_

- [ ] 3.1 实现独立的轮询检测逻辑
  - 在 blockchain-ws.js 中复制并优化原有的轮询代码
  - 实现每2秒检查一次新区块的机制
  - 优先检查最新的20个区块
  - 确保不调用原版文件的任何代码
  - _需求: 3.2, 3.3, 3.6_

- [ ] 3.2 实现智能区块范围检查
  - 记录上次检查的区块号避免重复检查
  - 实现从支付开始区块到当前区块的范围检查
  - 添加区块检查的批次处理逻辑
  - 优化检查顺序（最新区块优先）
  - _需求: 3.3, 3.5_

- [ ] 3.3 实现模式切换协调
  - WebSocket 连接失败时启动轮询模式
  - WebSocket 恢复时停止轮询切换回 WebSocket
  - 确保两种模式不会同时运行造成重复检查
  - 添加模式切换的状态提示
  - _需求: 3.1, 3.4, 3.5_

- [ ] 4. 实现支付检测优化逻辑
  - 优化交易扫描和验证逻辑
  - 实现快速的金额和代币匹配
  - 确保检测延迟控制在5秒以内
  - 添加检测状态的实时反馈
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 4.1 优化区块交易扫描逻辑
  - 实现快速的区块交易过滤
  - 只检查发送到目标地址的交易
  - 优化交易数据解析性能
  - 确保3秒内完成区块扫描
  - _需求: 4.1, 4.2_

- [ ] 4.2 实现精确的支付匹配验证
  - 验证交易金额、代币类型和接收地址
  - 实现容差范围内的金额匹配
  - 处理多笔可能匹配交易的情况
  - 选择最符合条件的交易进行确认
  - _需求: 4.3, 4.4_

- [ ] 4.3 实现支付确认和页面跳转
  - 交易确认数达到要求时立即触发成功流程
  - 实现快速的页面跳转到 success-ws.html
  - 保存完整的支付验证结果数据
  - 添加支付成功的状态更新
  - _需求: 4.4_

- [ ] 5. 集成 WebSocket 和轮询监听逻辑
  - 在 qrcode-ws.js 中集成 WebSocket 和轮询监听
  - 实现统一的支付监听控制器
  - 确保监听模式的智能切换
  - 添加详细的状态显示和调试信息
  - _需求: 2.5, 3.4, 6.1, 6.2, 6.3_

- [ ] 5.1 修改 qrcode-ws.js 集成监听逻辑
  - 移除原有的轮询代码，集成新的 WebSocket 监听
  - 实现 PaymentListenerWS 控制器类
  - 启动时优先尝试 WebSocket 连接
  - 所有端点失败时自动切换到轮询模式
  - _需求: 2.5, 3.1_

- [ ] 5.2 实现统一的事件处理
  - WebSocket 新区块事件和轮询检查使用相同的处理逻辑
  - 实现统一的支付确认流程
  - 确保两种模式的检测结果一致
  - 添加模式切换的无缝过渡
  - _需求: 3.4, 3.5_

- [ ] 5.3 添加状态显示和用户反馈
  - 显示当前使用的监听模式（WebSocket/轮询）
  - 显示 WebSocket 连接状态
  - 添加实时的检测进度提示
  - 提供模式切换的状态反馈
  - _需求: 6.1, 6.2, 6.3_

- [ ] 6. 创建基础测试工具
  - 在 demo/debug 目录创建测试页面
  - 实现 WebSocket 连接测试工具
  - 实现支付流程测试工具
  - 编写测试使用说明文档
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 6.1 创建 WebSocket 连接测试页面
  - 创建 demo/debug/websocket-test.html
  - 创建 demo/debug/js/websocket-test.js
  - 实现测试所有端点连接状态的功能
  - 添加模拟连接失败和重连的测试
  - _需求: 5.1_

- [ ] 6.2 创建支付流程测试页面
  - 创建 demo/debug/payment-flow-test.html
  - 创建 demo/debug/js/payment-test.js
  - 实现端到端支付流程验证
  - 添加模拟不同支付场景的功能
  - _需求: 5.2_

- [ ] 6.3 编写测试说明文档
  - 创建 demo/debug/README.md
  - 说明各个测试工具的使用方法
  - 提供常见问题的排查指南
  - 添加测试场景和预期结果说明
  - _需求: 5.4_

- [ ] 7. 系统集成测试和优化
  - 测试完整的支付流程
  - 验证 WebSocket 和轮询模式切换
  - 测试多种网络异常场景
  - 优化检测性能确保5秒内完成
  - _需求: 4.2, 6.4, 7.1, 7.2, 7.3_

- [ ] 7.1 端到端支付流程测试
  - 测试从首页到成功页面的完整流程
  - 验证不同代币和金额的支付检测
  - 测试不同钱包的兼容性
  - 确保页面跳转和数据传递正确
  - _需求: 6.4, 7.1_

- [ ] 7.2 网络异常和恢复测试
  - 测试 WebSocket 连接断开和重连
  - 测试所有端点失败时的轮询回退
  - 测试网络恢复时的模式切换
  - 验证异常情况下的用户体验
  - _需求: 7.2, 7.3_

- [ ] 7.3 性能优化和验证
  - 测试支付检测延迟是否在5秒以内
  - 优化区块扫描和交易匹配性能
  - 验证 WebSocket 模式的响应速度
  - 确保轮询模式的检测效率
  - _需求: 4.2, 6.4_